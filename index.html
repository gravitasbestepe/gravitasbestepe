<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Emission Simulator</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
:root{--bg:#fafafa;--card:#fff;--muted:#666}
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#222}
header{display:flex;align-items:center;gap:12px;padding:10px 14px;background:#0b5;box-shadow:0 2px 8px rgba(0,0,0,.06);flex-wrap:wrap}
header h1{font-size:18px;margin:0}
nav{display:flex;gap:8px;align-items:center}
nav button{background:transparent;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
nav button.active{background:rgba(255,255,255,.9)}
.lang-select{margin-left:auto;display:flex;gap:8px;align-items:center}
.lang-btn{padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.2);background:transparent;cursor:pointer}
.lang-btn.active{background:white}
main{padding:12px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
.card{background:var(--card);padding:10px;border-radius:8px;box-shadow:0 4px 16px rgba(12,12,12,.04)}
#map,#globalMap,#nationalMap, #aqiMap {height:420px;border-radius:8px}
#aqiControls { display:flex; gap:6px; align-items:center; flex-wrap:wrap; padding:8px 0; border-bottom:1px solid #eee; margin-bottom: 8px;}
#addressWrapper { flex:1; position:relative; min-width:180px; }
#aqiAddressInput { width:100%; padding:5px 38px 5px 8px; font-size:13px; border:1px solid #ccc; border-radius:5px; height:28px; box-sizing:border-box;}
#aqiClearBtn { position:absolute; right:3px; top:50%; transform:translateY(-50%); padding:2px 6px; font-size:12px; border-radius:5px; border:1px solid #bbb; background:white; cursor:pointer; }
#aqiLocateBtn { padding:5px 10px; cursor:pointer; border-radius:6px; border:1px solid #bbb; background:white; height:38px; font-size:13px; }
#aqiResultList { position:absolute; left:0; right:0; top:38px; background:white; box-shadow:0 4px 12px rgba(0,0,0,.08); border-radius:5px; z-index:1000; max-height:300px; overflow:auto; display:none; font-size:13px; border:1px solid #ccc; }
.resultItem { padding:6px 8px; border-bottom:1px solid #eee; cursor:pointer; }
.resultItem:hover { background:#f0f7ff; }
.aqi-bar{height:18px;width:100%;background:#ddd;margin:4px 0;border-radius:5px;overflow:hidden}
.aqi-fill{height:100%;width:0%;background:green;text-align:center;color:white;font-weight:bold;font-size:12px; line-height: 18px;}
label{font-size:13px;color:var(--muted)}
.muted{color:var(--muted);font-size:13px}
.btn{display:inline-block;padding:8px 10px;border-radius:6px;border:1px solid #bbb;background:white;cursor:pointer}
.pollutant-list { margin: 8px 0; padding-left: 15px; font-size: 13px; list-style-type: none; }
.pollutant-list li { margin-bottom: 3px; }
@media(max-width:900px){.grid{grid-template-columns:1fr}#map{height:300px}}
</style>
</head>
<body>
<header>
<h1 id="title">Emission Simulator (Demo)</h1>
<nav>
<button id="nav-home" class="active">Home</button>
<button id="nav-register">Device Register</button>
<button id="nav-vehicle">My Vehicles</button>
<button id="nav-rules">Rules & Advice</button>
<button id="nav-global">Global Emission Map</button>
<button id="nav-aqi">Detailed AQI Map</button>
</nav>
<div class="lang-select" aria-hidden="false">
<button class="lang-btn" data-lang="en" id="lang-en">EN</button>
<button class="lang-btn" data-lang="tr" id="lang-tr">TR</button>
<button class="lang-btn" data-lang="de" id="lang-de">DE</button>
<button class="lang-btn" data-lang="ru" id="lang-ru">RU</button>
</div>
</header>
<main>
<section id="page-home">
<div class="grid">
<div class="card">
<h2 id="home-title">Quick Vehicle Emission Simulator</h2>
<p class="muted" id="home-desc">Register your device and get simulated emission readings here.</p>
<div style="margin-top:10px">
<h3 id="lastReadLabel">Last Reading</h3>
<div id="lastRead" class="muted">No readings yet.</div>
<hr/>
<h3 id="behaviourLabel">System Behaviour</h3>
<p class="muted" id="behaviourText">This demo simulates device readings and traffic eligibility.</p>
</div>
</div>
<aside class="card">
<h3 id="quickRegisterTitle">Device Registration</h3>
<p class="muted" id="quickRegisterDesc">Use the Device Register tab to manage vehicles.</p>
</aside>
</div>
</section>
<section id="page-register" style="display:none">
<div class="card">
<h2 id="regTitle">Device Register</h2>
<label id="reg_plate_label">Plate</label>
<input id="reg_plate" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc"/>
<label id="reg_device_label">Device ID</label>
<input id="reg_device" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc"/>
<label id="reg_city_label">City</label>
<input id="reg_city" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc"/>
<button id="regBtn" class="btn">Create Register</button>
<hr/>
<h3 id="registeredTitle">Registered Devices</h3>
<div id="registeredList"></div>
</div>
</section>
<section id="page-vehicle" style="display:none">
<div class="card">
<h2 id="myVehiclesTitle">My Vehicles</h2>
<div id="myVehicles"></div>
</div>
</section>
<section id="page-rules" style="display:none">
<div class="card">
<h2 id="rulesTitle">Rules & Advice</h2>
<ul>
<li id="rule1">PM2.5 &gt; 150 => Traffic ban recommended.</li>
<li id="rule2">PM2.5 100-150 => Limited (restricted times).</li>
<li id="rule3">PM2.5 &lt;= 100 => Normal traffic permitted.</li>
</ul>
<h3 id="adviceTitle">Advice</h3>
<ol>
<li id="advice1">Check filters and catalytic converter.</li>
<li id="advice2">Routine maintenance.</li>
<li id="advice3">Reduce idling.</li>
</ol>
</div>
</section>
<section id="page-global" style="display:none">
<div class="card">
<h2 id="globalTitle">Global Emission Hotspots (Simulated)</h2>
<p class="muted" id="globalDesc">Showing simulated dangerous hotspots around the world. Not real data ‚Äî demo only.</p>
<div id="globalMap"></div>
<div id="globalSummary" style="margin-top:8px" class="muted"></div>
</div>
</section>
<section id="page-aqi" style="display:none">
<div class="grid">
    <div class="card">
        <h2 id="aqiMapTitle">Interactive Air Quality Map</h2>
        <div id="aqiControls">
            <div id="addressWrapper">
                <input id="aqiAddressInput" placeholder="Enter city or address" autocomplete="off" />
                <button id="aqiClearBtn">Clear</button>
                <div id="aqiResultList"></div>
            </div>
            <button id="aqiLocateBtn">Locate Me</button>
        </div>
        <div id="aqiMap"></div>
    </div>
    <aside class="card" id="aqiDetailsCard">
        <h3 id="aqiDetailTitle">Air Quality Details</h3>
        <h4 id="aqiLocationLabel">Location: ‚Äî</h4>
        <div class="aqi-bar"><div id="detailAqiBar" class="aqi-fill">‚Äî</div></div>
        <p id="detailAqiText" style="margin-bottom: 4px;">AQI: ‚Äî</p>
        <p id="detailDominantPollutant">Dominant Pollutant: ‚Äî</p>
        <hr/>
        <h4 id="pollutantTitle">Pollutant Details (¬µg/m¬≥)</h4>
        <ul id="pollutantsList" class="pollutant-list">
            <li class="muted" id="pollutantsPlaceholder">Click on the map or search for a location.</li>
        </ul>
        <hr/>
        <p id="detailWarningMsg" style="color:#b22222; font-weight:bold; font-size:13px; margin-top: 8px;"></p>
        <p id="detailMaskMsg" style="color:#0000aa; font-weight:bold; font-size:13px;"></p>
    </aside>
</div>
</section>
</main>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const WAQI_TOKEN="9263e25a74b0d93c30387fa753ec876f19869d38";
const NOMINATIM_BASE="https://nominatim.openstreetmap.org";

const translations = {
    en: {
        title: "Emission Simulator (Demo)",
        nav: { home:"Home", register:"Device Register", vehicle:"My Vehicles", rules:"Rules & Advice", global:"Global Emission Map", aqi: "Detailed AQI Map" },
        homeTitle: "Quick Vehicle Emission Simulator",
        homeDesc: "Register your device and get simulated emission readings here.",
        lastReadLabel: "Last Reading", behaviourLabel: "System Behaviour",
        behaviourText: "This demo simulates device readings and traffic eligibility.",
        quickRegisterTitle: "Device Registration",
        quickRegisterDesc: "Use the Device Register tab to manage vehicles.",
        registerSuccess: "Registration created (demo).", simulateAll: "Simulate All Now",
        aqiMapTitle: "Interactive Air Quality Map", aqiDetailTitle: "Air Quality Details",
        aqiLocation: "Location", aqiText: "AQI", aqiPollutant: "Dominant Pollutant", locateBtn: "Locate Me", aqiClear: "Clear",
        pollutantTitle: "Pollutant Details (¬µg/m¬≥)",
        pollutantPlaceholder: "Click on the map or search for a location.",
        aqiNoData: "AQI data not available for this location.",
        aqiWarning_good: "‚úÖ Air quality is good for everyone.",
        aqiWarning_moderate: "‚ö†Ô∏è Moderate. Sensitive people should take care.",
        aqiWarning_usg: "‚ö†Ô∏è Unhealthy for sensitive groups. Limit outdoor activity.",
        aqiWarning_unhealthy: "‚ùå Unhealthy. Avoid outdoor exercise.",
        aqiWarning_v_unhealthy: "‚ò†Ô∏è Very unhealthy. Everyone should stay indoors.",
        aqiWarning_hazardous: "üö´ Hazardous. Stay indoors.",
        aqiMask_usg: "Consider wearing a mask if you have respiratory conditions.",
        aqiMask_unhealthy: "Wear a mask if going outside.",
        aqiMask_v_unhealthy: "Use a high-quality mask if you must go out.",
        aqiMask_hazardous: "Wear a mask and use air purifier.",
    },
    tr: {
        title: "Emisyon Sim√ºlat√∂r√º (Demo)",
        nav: { home:"Anasayfa", register:"Cihaz Kayƒ±t", vehicle:"Ara√ßlarƒ±m", rules:"Kurallar & √ñneriler", global:"Global Emisyon Haritasƒ±", aqi: "Detaylƒ± HKƒ∞ Haritasƒ±" },
        homeTitle: "Hƒ±zlƒ± Ara√ß Emisyon Sim√ºlat√∂r√º",
        homeDesc: "Cihazƒ±nƒ±zƒ± kaydedin ve sim√ºle emisyon okumalarƒ± alƒ±n.",
        lastReadLabel: "Son Okuma", behaviourLabel: "Sistem Davranƒ±≈üƒ±",
        behaviourText: "Bu demo, cihaz okumalarƒ±nƒ± ve trafik uygunluƒüunu sim√ºle eder.",
        quickRegisterTitle: "Cihaz Kayƒ±t",
        quickRegisterDesc: "Ara√ßlarƒ± y√∂netmek i√ßin Cihaz Kayƒ±t sekmesini kullanƒ±n.",
        registerSuccess: "Kayƒ±t olu≈üturuldu (demo).", simulateAll: "T√ºm√ºn√º Sim√ºle Et",
        aqiMapTitle: "Etkile≈üimli Hava Kalitesi Haritasƒ±", aqiDetailTitle: "Hava Kalitesi Detaylarƒ±",
        aqiLocation: "Konum", aqiText: "HKƒ∞", aqiPollutant: "Baskƒ±n Kirletici", locateBtn: "Konumumu Bul", aqiClear: "Temizle",
        pollutantTitle: "Kirletici Detaylarƒ± (¬µg/m¬≥)",
        pollutantPlaceholder: "Haritaya tƒ±klayƒ±n veya bir konum arayƒ±n.",
        aqiNoData: "Bu konum i√ßin HKƒ∞ verisi mevcut deƒüil.",
        aqiWarning_good: "‚úÖ Hava kalitesi herkes i√ßin iyi.",
        aqiWarning_moderate: "‚ö†Ô∏è Orta. Hassas ki≈üilerin dikkatli olmasƒ± gerekir.",
        aqiWarning_usg: "‚ö†Ô∏è Hassas gruplar i√ßin saƒülƒ±ksƒ±z. Dƒ±≈üarƒ±daki aktiviteleri sƒ±nƒ±rlayƒ±n.",
        aqiWarning_unhealthy: "‚ùå Saƒülƒ±ksƒ±z. Dƒ±≈üarƒ±da egzersiz yapmaktan ka√ßƒ±nƒ±n.",
        aqiWarning_v_unhealthy: "‚ò†Ô∏è √áok saƒülƒ±ksƒ±z. Herkes i√ßeride kalmalƒ±.",
        aqiWarning_hazardous: "üö´ Tehlikeli. ƒ∞√ßeride kalƒ±n.",
        aqiMask_usg: "Solunum rahatsƒ±zlƒ±ƒüƒ±nƒ±z varsa maske takmayƒ± d√º≈ü√ºn√ºn.",
        aqiMask_unhealthy: "Dƒ±≈üarƒ± √ßƒ±kacaksanƒ±z maske takƒ±n.",
        aqiMask_v_unhealthy: "Dƒ±≈üarƒ± √ßƒ±kmanƒ±z gerekiyorsa y√ºksek kaliteli maske kullanƒ±n.",
        aqiMask_hazardous: "Maske takƒ±n ve hava temizleyici kullanƒ±n.",
    },
    de: { 
        title: "Emissionssimulator (Demo)",
        nav: { home:"Start", register:"Ger√§t Registr.", vehicle:"Meine Fahrzeuge", rules:"Regeln & Tipps", global:"Globale Emissionskarte", aqi: "Detaillierte AQI Karte" },
        homeTitle: "Schneller Fahrzeug-Emissionssimulator",
        homeDesc: "Registrieren Sie Ihr Ger√§t und erhalten Sie simulierte Emissionswerte.",
        lastReadLabel: "Letzte Messung", behaviourLabel: "Systemverhalten",
        behaviourText: "Dieses Demo simuliert Ger√§teablesungen und Verkehrstauglichkeit.",
        quickRegisterTitle: "Ger√§t registrieren",
        quickRegisterDesc: "Verwenden Sie den Ger√§te-Register-Tab, um Fahrzeuge zu verwalten.",
        registerSuccess: "Registrierung erstellt (Demo).", simulateAll: "Jetzt simulieren",
        aqiMapTitle: "Interaktive Luftqualit√§tskarte", aqiDetailTitle: "Luftqualit√§tsdetails",
        aqiLocation: "Ort", aqiText: "AQI", aqiPollutant: "Dominanter Schadstoff", locateBtn: "Standort finden", aqiClear: "L√∂schen",
        pollutantTitle: "Schadstoffdetails (¬µg/m¬≥)",
        pollutantPlaceholder: "Klicken Sie auf die Karte oder suchen Sie nach einem Ort.",
        aqiNoData: "AQI-Daten f√ºr diesen Standort nicht verf√ºgbar.",
        aqiWarning_good: "‚úÖ Luftqualit√§t ist gut f√ºr alle.",
        aqiWarning_moderate: "‚ö†Ô∏è M√§√üig. Empfindliche Personen sollten vorsichtig sein.",
        aqiWarning_usg: "‚ö†Ô∏è Ungesund f√ºr empfindliche Gruppen. Begrenzen Sie Aktivit√§ten im Freien.",
        aqiWarning_unhealthy: "‚ùå Ungesund. Vermeiden Sie Sport im Freien.",
        aqiWarning_v_unhealthy: "‚ò†Ô∏è Sehr ungesund. Alle sollten drinnen bleiben.",
        aqiWarning_hazardous: "üö´ Gef√§hrlich. Drinnen bleiben.",
        aqiMask_usg: "Erw√§gen Sie das Tragen einer Maske, wenn Sie Atemwegserkrankungen haben.",
        aqiMask_unhealthy: "Tragen Sie eine Maske, wenn Sie nach drau√üen gehen.",
        aqiMask_v_unhealthy: "Verwenden Sie eine hochwertige Maske, wenn Sie raus m√ºssen.",
        aqiMask_hazardous: "Tragen Sie eine Maske und verwenden Sie einen Luftreiniger.",
    },
    ru: { 
        title: "–°–∏–º—É–ª—è—Ç–æ—Ä –≤—ã–±—Ä–æ—Å–æ–≤ (–¥–µ–º–æ)",
        nav: { home:"–ì–ª–∞–≤–Ω–∞—è", register:"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞", vehicle:"–ú–æ–∏ –∞–≤—Ç–æ", rules:"–ü—Ä–∞–≤–∏–ª–∞ –∏ —Å–æ–≤–µ—Ç—ã", global:"–ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –≤—ã–±—Ä–æ—Å–æ–≤", aqi: "–ü–æ–¥—Ä–æ–±–Ω–∞—è –∫–∞—Ä—Ç–∞ AQI" },
        homeTitle: "–ë—ã—Å—Ç—Ä—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä –≤—ã–±—Ä–æ—Å–æ–≤ –∞–≤—Ç–æ–º–æ–±–∏–ª—è",
        homeDesc: "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –ø–æ–ª—É—á–∏—Ç–µ —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è.",
        lastReadLabel: "–ü–æ—Å–ª–µ–¥–Ω–µ–µ —á—Ç–µ–Ω–∏–µ", behaviourLabel: "–ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã",
        behaviourText: "–î–µ–º–æ —Å–∏–º—É–ª–∏—Ä—É–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç—å –≤ —Ç—Ä–∞—Ñ–∏–∫–µ.",
        quickRegisterTitle: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞",
        quickRegisterDesc: "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∫–ª–∞–¥–∫—É ¬´–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞¬ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏.",
        registerSuccess: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ (–¥–µ–º–æ).", simulateAll: "–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë",
        aqiMapTitle: "–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–∑–¥—É—Ö–∞", aqiDetailTitle: "–î–µ—Ç–∞–ª–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–∑–¥—É—Ö–∞",
        aqiLocation: "–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ", aqiText: "AQI", aqiPollutant: "–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–≥—Ä—è–∑–Ω–∏—Ç–µ–ª—å", locateBtn: "–ù–∞–π—Ç–∏ –º–µ–Ω—è", aqiClear: "–û—á–∏—Å—Ç–∏—Ç—å",
        pollutantTitle: "–î–µ—Ç–∞–ª–∏ –∑–∞–≥—Ä—è–∑–Ω–∏—Ç–µ–ª–µ–π (–º–∫–≥/–º¬≥)",
        pollutantPlaceholder: "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.",
        aqiNoData: "–î–∞–Ω–Ω—ã–µ AQI –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.",
        aqiWarning_good: "‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞ —Ö–æ—Ä–æ—à–µ–µ –¥–ª—è –≤—Å–µ—Ö.",
        aqiWarning_moderate: "‚ö†Ô∏è –£–º–µ—Ä–µ–Ω–Ω–æ–µ. –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º –ª—é–¥—è–º —Å–ª–µ–¥—É–µ—Ç –±—ã—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–º–∏.",
        aqiWarning_usg: "‚ö†Ô∏è –ù–µ–∑–¥–æ—Ä–æ–≤–æ–µ –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –≥—Ä—É–ø–ø. –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ —É–ª–∏—Ü–µ.",
        aqiWarning_unhealthy: "‚ùå –ù–µ–∑–¥–æ—Ä–æ–≤–æ–µ. –ò–∑–±–µ–≥–∞–π—Ç–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ —É–ª–∏—Ü–µ.",
        aqiWarning_v_unhealthy: "‚ò†Ô∏è –û—á–µ–Ω—å –Ω–µ–∑–¥–æ—Ä–æ–≤–æ–µ. –í—Å–µ–º —Å–ª–µ–¥—É–µ—Ç –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏.",
        aqiWarning_hazardous: "üö´ –û–ø–∞—Å–Ω–æ. –û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏.",
        aqiMask_usg: "–ü–æ–¥—É–º–∞–π—Ç–µ –æ –Ω–æ—à–µ–Ω–∏–∏ –º–∞—Å–∫–∏, –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π.",
        aqiMask_unhealthy: "–ù–æ—Å–∏—Ç–µ –º–∞—Å–∫—É, –µ—Å–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç–µ –Ω–∞ —É–ª–∏—Ü—É.",
        aqiMask_v_unhealthy: "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—É—é –º–∞—Å–∫—É, –µ—Å–ª–∏ –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–π—Ç–∏.",
        aqiMask_hazardous: "–ù–æ—Å–∏—Ç–µ –º–∞—Å–∫—É –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—á–∏—Å—Ç–∏—Ç–µ–ª—å –≤–æ–∑–¥—É—Ö–∞.",
    }
};

let lang = localStorage.getItem('site_lang') || 'en';

const pages = {
    home: document.getElementById('page-home'),
    register: document.getElementById('page-register'),
    vehicle: document.getElementById('page-vehicle'),
    rules: document.getElementById('page-rules'),
    global: document.getElementById('page-global'),
    aqi: document.getElementById('page-aqi')
};
function show(page){
    Object.values(pages).forEach(p => p.style.display = 'none');
    pages[page].style.display = 'block';
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById('nav-' + page).classList.add('active');
    if (page === 'global') {
        setTimeout(() => { initGlobalMap(); if (window.globalMap) window.globalMap.invalidateSize(); }, 200);
    } else if (page === 'aqi') {
        setTimeout(() => { initAqiMap(); if (window.aqiMap) window.aqiMap.invalidateSize(); }, 200);
    }
}
document.getElementById('nav-home').addEventListener('click', ()=>show('home'));
document.getElementById('nav-register').addEventListener('click', ()=>show('register'));
document.getElementById('nav-vehicle').addEventListener('click', ()=>show('vehicle'));
document.getElementById('nav-rules').addEventListener('click', ()=>show('rules'));
document.getElementById('nav-global').addEventListener('click', ()=>show('global'));
document.getElementById('nav-aqi').addEventListener('click', ()=>show('aqi'));

function setLanguage(l){
    lang = l;
    localStorage.setItem('site_lang', l);
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.dataset.lang === l));
    applyTranslations();
}
document.querySelectorAll('.lang-btn').forEach(b => {
    b.addEventListener('click', ()=>setLanguage(b.dataset.lang));
});
setLanguage(lang);

function applyTranslations(){
    const t = translations[lang] || translations.en;
    document.getElementById('title').textContent = t.title;
    document.getElementById('nav-home').textContent = t.nav.home;
    document.getElementById('nav-register').textContent = t.nav.register;
    document.getElementById('nav-vehicle').textContent = t.nav.vehicle;
    document.getElementById('nav-rules').textContent = t.nav.rules;
    document.getElementById('nav-global').textContent = t.nav.global;
    document.getElementById('nav-aqi').textContent = t.nav.aqi;
    document.getElementById('home-title').textContent = t.homeTitle;
    document.getElementById('home-desc').textContent = t.homeDesc;
    document.getElementById('lastReadLabel').textContent = t.lastReadLabel;
    document.getElementById('behaviourLabel').textContent = t.behaviourLabel;
    document.getElementById('behaviourText').textContent = t.behaviourText;
    document.getElementById('quickRegisterTitle').textContent = t.quickRegisterTitle;
    document.getElementById('quickRegisterDesc').textContent = t.quickRegisterDesc;
    document.getElementById('regTitle').textContent = t.regTitle;
    document.getElementById('registeredTitle').textContent = t.registeredTitle;
    document.getElementById('myVehiclesTitle').textContent = t.myVehiclesTitle;
    document.getElementById('rulesTitle').textContent = t.rulesTitle;
    document.getElementById('globalTitle').textContent = t.globalTitle;
    document.getElementById('globalDesc').textContent = t.globalDesc;

    // AQI Page √ßevirileri g√ºncellendi
    document.getElementById('aqiMapTitle').textContent = t.aqiMapTitle;
    document.getElementById('aqiDetailTitle').textContent = t.aqiDetailTitle;
    document.getElementById('aqiLocateBtn').textContent = t.locateBtn;
    document.getElementById('aqiClearBtn').textContent = t.aqiClear; // 'Clear' butonu
    document.getElementById('pollutantTitle').textContent = t.pollutantTitle;
    document.getElementById('pollutantsPlaceholder').textContent = t.pollutantPlaceholder;
    document.getElementById('aqiAddressInput').placeholder = 'Enter city or address'; // Placeholder sabit kalabilir

    resetAqiDetails(document.getElementById('aqiAddressInput').value || '‚Äî');
}

function debounce(fn,wait){let t;return function(...args){clearTimeout(t);t=setTimeout(()=>fn.apply(this,args),wait);};}

function loadRegistry(){
    try{ return JSON.parse(localStorage.getItem('emission_registry')||'[]'); } catch(e){ return []; }
}
function saveRegistry(reg){
    localStorage.setItem('emission_registry', JSON.stringify(reg));
}
function renderRegistered(){
    const list = document.getElementById('registeredList');
    const reg = loadRegistry();
    if(!list) return;
    if(reg.length === 0){ list.innerHTML = '<div class="muted">No devices.</div>'; return; }
    list.innerHTML = '';
    reg.forEach(r => {
        const div = document.createElement('div');
        div.style.padding='8px';
        div.style.borderBottom='1px solid #eee';
        div.innerHTML = `<strong>${r.plate}</strong> ‚Äî ${r.device} <div class="muted">${r.city || ''}</div>`;
        list.appendChild(div);
    });
}
function renderMyVehicles(){
    const cont = document.getElementById('myVehicles');
    const reg = loadRegistry();
    if(!cont) return;
    if(reg.length === 0){ cont.innerHTML = '<div class="muted">No vehicles.</div>'; return; }
    cont.innerHTML = '';
    reg.forEach((r, idx) => {
        const box = document.createElement('div');
        box.style.border='1px solid #eee';
        box.style.padding='8px';
        box.style.borderRadius='6px';
        box.style.marginBottom='8px';
        const last = r.lastRead ? `<div>PM2.5: <strong>${r.lastRead.pm25}</strong> ‚Äî Status: <strong>${r.lastRead.status}</strong></div>` : '<div class="muted">No readings yet.</div>';
        box.innerHTML = `<strong>${r.plate}</strong> ‚Äî ${r.device}<div class="muted">${r.model||''} ${r.city?'- '+r.city:''}</div>${last}<div style="margin-top:8px"><button class="btn" data-idx="${idx}" onclick="forceRead(this)">Manual Read</button> <button class="btn" data-idx="${idx}" onclick="simulateTrip(this)">Simulate Trip</button></div>`;
        cont.appendChild(box);
    });
}
document.getElementById('regBtn').addEventListener('click', ()=>{
    const plate = document.getElementById('reg_plate').value.trim();
    const device = document.getElementById('reg_device').value.trim();
    const city = document.getElementById('reg_city').value.trim();
    if(!plate || !device){ alert('Plate and device required'); return; }
    const reg = loadRegistry();
    reg.push({ plate, device, city, created: Date.now(), lastRead: null });
    saveRegistry(reg);
    renderRegistered();
    renderMyVehicles();
    alert(translations[lang].registerSuccess);
    const idx = reg.length - 1;
    gradualChange(idx, { start: 20, target: Math.round(Math.random()*140+10), steps: 6, interval: 2500 });
});
window.forceRead = function(btn){
    const idx = parseInt(btn.dataset.idx);
    simulateDeviceRead(idx);
}
window.simulateTrip = function(btn){
    const idx = parseInt(btn.dataset.idx);
    const reg = loadRegistry();
    if(!reg[idx]) return;
    gradualChange(idx, {
        start: reg[idx].lastRead ? reg[idx].lastRead.pm25 : 30,
        target: Math.min(400, Math.round((reg[idx].lastRead?reg[idx].lastRead.pm25:30) * (1.6 + Math.random()*0.6))),
        steps: 8, interval: 3000
    });
}
function simulateDeviceRead(index, opts = {}){
    const reg = loadRegistry();
    if(!reg[index]) return;
    const basePM25 = Math.round(Math.random()*180);
    const pm25 = Math.max(0, Math.round(basePM25 * (opts.multiply||1)));
    const pm10 = Math.round(pm25 * (0.6 + Math.random()*0.8));
    const co = (Math.random()*6).toFixed(2);
    const status = decideStatus(pm25);
    const read = { ts: Date.now(), pm25, pm10, co, status };
    reg[index].lastRead = read;
    saveRegistry(reg);
    renderMyVehicles();
    document.getElementById('lastRead').innerHTML = `${reg[index].plate} ‚Äî PM2.5: ${pm25} ‚Äî ${status}`;
}
function decideStatus(pm25){
    if(pm25 > 150) return 'TRAFFIC NOT ALLOWED';
    if(pm25 > 100) return 'LIMITED (RESTRICTED TIMES)';
    return 'TRAFFIC ALLOWED';
}
function gradualChange(index, opts={start:20,target:80,steps:6,interval:3000}){
    const reg = loadRegistry();
    if(!reg[index]) return;
    let step = 0;
    const start = opts.start;
    const target = opts.target;
    const steps = opts.steps||6;
    const interval = opts.interval||3000;
    const delta = (target - start) / steps;
    const iv = setInterval(()=>{
        step++;
        const currentVal = Math.round(start + delta*step + (Math.random()*5-2));
        const pm25 = Math.max(0, currentVal);
        const pm10 = Math.round(pm25 * (0.6 + Math.random()*0.8));
        const co = (Math.random()*6).toFixed(2);
        const status = decideStatus(pm25);
        const read = { ts: Date.now(), pm25, pm10, co, status };
        const registry = loadRegistry();
        if(!registry[index]){ clearInterval(iv); return; }
        registry[index].lastRead = read;
        saveRegistry(registry);
        renderMyVehicles();
        document.getElementById('lastRead').innerHTML = `${registry[index].plate} ‚Äî PM2.5: ${pm25} ‚Äî ${status}`;
        if(step >= steps) clearInterval(iv);
    }, interval);
}

function startBackgroundSimulation(){
    setInterval(()=>{
        const reg = loadRegistry();
        if(!reg.length) return;
        for(let i=0;i<reg.length;i++){
            if(Math.random() < 0.5) simulateDeviceRead(i);
        }
        renderMyVehicles();
    }, 20000);
}

let globalMap = null;
function initGlobalMap(){
    if(globalMap) return;
    globalMap = L.map('globalMap').setView([20,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(globalMap); // Tile Layer eklendi
    const hotspots = [
        {name:'Delhi, India', lat:28.7041, lon:77.1025, pm25: 320},
        {name:'Beijing, China', lat:39.9042, lon:116.4074, pm25: 280},
        {name:'Lahore, Pakistan', lat:31.5204, lon:74.3587, pm25: 260},
        {name:'Dhaka, Bangladesh', lat:23.8103, lon:90.4125, pm25: 240},
        {name:'Karachi, Pakistan', lat:24.8607, lon:67.0011, pm25: 220},
        {name:'Ulaanbaatar, Mongolia', lat:47.8864, lon:106.9057, pm25: 300},
        {name:'Mexico City, Mexico', lat:19.4326, lon:-99.1332, pm25: 180},
        {name:'Silesia, Poland (industrial)', lat:50.3, lon:18.7, pm25: 190},
        {name:'Los Angeles, USA (urban)', lat:34.05, lon:-118.24, pm25: 110},
        {name:'Moscow, Russia', lat:55.7558, lon:37.6176, pm25: 100},
        {name:'Istanbul, Turkey', lat:41.0, lon:28.97, pm25: 120}
    ];
    hotspots.forEach(h=>{
        const color = getColorForPM25(h.pm25);
        const marker = L.circle([h.lat,h.lon], {
            radius: Math.min(50000, h.pm25*300),
            color, fillColor: color, fillOpacity:0.5
        }).addTo(globalMap);
        marker.bindPopup(`<strong>${h.name}</strong><br>Simulated PM2.5: ${h.pm25}`);
    });
    document.getElementById('globalSummary').innerHTML = '<div class="muted">Hotspots shown are simulated and only for demo purposes.</div>';
}
function getColorForPM25(v){
    if(v<=50) return 'green';
    if(v<=100) return 'yellow';
    if(v<=150) return 'orange';
    if(v<=200) return 'red';
    if(v<=300) return 'purple';
    return 'maroon';
}

let aqiMap = null;
let aqiMarker = null;

const aqiAddressInput=document.getElementById('aqiAddressInput');
const aqiResultList=document.getElementById('aqiResultList');
const aqiLocateBtn=document.getElementById('aqiLocateBtn');
const aqiClearBtn=document.getElementById('aqiClearBtn');
const aqiLocationLabel=document.getElementById('aqiLocationLabel');
const detailAqiBar=document.getElementById('detailAqiBar');
const detailAqiText=document.getElementById('detailAqiText');
const detailDominantPollutant=document.getElementById('detailDominantPollutant');
const pollutantsList=document.getElementById('pollutantsList');
const detailWarningMsg=document.getElementById('detailWarningMsg');
const detailMaskMsg=document.getElementById('detailMaskMsg');

function initAqiMap(){
    if(aqiMap) return;
    aqiMap=L.map('aqiMap').setView([39.925,32.866],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(aqiMap); // Tile Layer eklendi
    
    aqiMap.on('click',function(e){
        const lat=e.latlng.lat;
        const lon=e.latlng.lng;
        nominatimReverse(lat, lon).then(rev => {
            const label = rev && rev.display_name ? rev.display_name : `Selected Point (${lat.toFixed(3)}, ${lon.toFixed(3)})`;
            goToAqiLocation(lat, lon, label);
            aqiAddressInput.value = label;
            aqiResultList.style.display = 'none';
        });
    });
}

function setAqiMarker(lat,lon){
    if(aqiMarker) aqiMap.removeLayer(aqiMarker);
    aqiMarker=L.marker([lat,lon]).addTo(aqiMap);
    aqiMap.setView([lat,lon], 12);
}

async function nominatimSearch(q){
    const res=await fetch(`${NOMINATIM_BASE}/search?format=json&addressdetails=1&limit=10&q=${encodeURIComponent(q)}`,{headers:{'Accept-Language':lang}});
    return res.json();
}

async function nominatimReverse(lat,lon){
    const res=await fetch(`${NOMINATIM_BASE}/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`,{headers:{'Accept-Language':lang}});
    return res.json();
}

function renderAqiResults(items){
    aqiResultList.innerHTML="";
    if(!items||items.length===0){aqiResultList.style.display="none";return;}
    items.forEach(item=>{
        const div=document.createElement('div');
        div.className='resultItem';
        div.innerHTML=`${item.display_name}`;
        div.tabIndex=0;
        div.addEventListener('click',()=>selectAqiResult(item));
        div.addEventListener('keydown',(e)=>{if(e.key==='Enter')selectAqiResult(item);});
        aqiResultList.appendChild(div);
    });
    aqiResultList.style.display='block';
}

async function selectAqiResult(item){
    aqiResultList.style.display='none';
    aqiAddressInput.value=item.display_name;
    goToAqiLocation(parseFloat(item.lat),parseFloat(item.lon),item.display_name);
}

function resetAqiDetails(label){
    const t = translations[lang] || translations.en;
    aqiLocationLabel.textContent=`${t.aqiLocation}: ${label||'‚Äî'}`;
    detailAqiText.textContent=`${t.aqiText}: ‚Äî`;
    detailDominantPollutant.textContent=`${t.aqiPollutant}: ‚Äî`;
    detailAqiBar.style.background="#999";
    detailAqiBar.style.width="0%";
    detailAqiBar.textContent="‚Äî";
    detailWarningMsg.textContent="";
    detailMaskMsg.textContent="";
    pollutantsList.innerHTML=`<li class="muted" id="pollutantsPlaceholder">${t.pollutantPlaceholder}</li>`;
}

function updateAqiUI(data,label){
    const t = translations[lang] || translations.en;
    aqiLocationLabel.textContent=`${t.aqiLocation}: ${label||'‚Äî'}`;
    const aqi=data&&data.aqi?data.aqi:null;
    detailAqiText.textContent=`${t.aqiText}: ${aqi!==null?aqi:'‚Äî'}`;
    detailDominantPollutant.textContent=`${t.aqiPollutant}: ${((data&&data.dominentpol)?data.dominentpol.toUpperCase():'‚Äî')}`;

    let color="#999";
    let warning="",mask="";
    const percent = aqi===null?0:Math.min(aqi,500)/500*100;

    if(aqi===null){warning="";mask="";}
    else if(aqi<=50){color="green"; warning=t.aqiWarning_good; mask="";}
    else if(aqi<=100){color="yellow"; warning=t.aqiWarning_moderate; mask="";}
    else if(aqi<=150){color="orange"; warning=t.aqiWarning_usg; mask=t.aqiMask_usg;}
    else if(aqi<=200){color="red"; warning=t.aqiWarning_unhealthy; mask=t.aqiMask_unhealthy;}
    else if(aqi<=300){color="purple"; warning=t.aqiWarning_v_unhealthy; mask=t.aqiMask_v_unhealthy;}
    else{color="maroon"; warning=t.aqiWarning_hazardous; mask=t.aqiMask_hazardous;}

    detailAqiBar.style.background=color;
    detailAqiBar.style.width=percent+"%";
    detailAqiBar.textContent=(aqi===null?'‚Äî':aqi);
    detailWarningMsg.textContent=warning;
    detailMaskMsg.textContent=mask;

    pollutantsList.innerHTML = '';
    const pollutantKeys=["pm25","pm10","o3","no2","so2","co","h","p","t","w"];
    if(data && data.iaqi){
        pollutantKeys.forEach(k=>{
            if(data.iaqi[k]){
                const value = data.iaqi[k].v;
                let quality = '‚Äî';
                if(k === 'pm25' || k === 'pm10' || k === 'o3' || k === 'no2' || k === 'so2' || k === 'co'){
                    if(value <= 50) quality = '(Good)';
                    else if(value <= 100) quality = '(Moderate)';
                    else quality = '(High)';
                }
                const li=document.createElement('li');
                li.innerHTML=`<strong>${k.toUpperCase()}</strong>: ${value} <span class="muted">${quality}</span>`;
                pollutantsList.appendChild(li);
            }
        });
    }
}

async function fetchAqiData(lat,lon,label){
    try{
        resetAqiDetails(label);
        const res=await fetch(`https://api.waqi.info/feed/geo:${lat};${lon}/?token=${WAQI_TOKEN}`);
        const resp=await res.json();
        if(resp.status==="ok"){
            updateAqiUI(resp.data,label);
        } else {
            updateAqiUI(null, label);
            alert(translations[lang].aqiNoData);
        }
    }catch(err){
        updateAqiUI(null, label);
        alert("Error fetching AQI data.");
        console.error(err);
    }
}

async function goToAqiLocation(lat,lon,label){
    setAqiMarker(lat,lon);
    fetchAqiData(lat,lon,label);
}

// Adres aramasƒ± ve otomatik tamamlama i≈ülevi d√ºzeltildi
aqiAddressInput.addEventListener('input',debounce(async()=>{
    const q=aqiAddressInput.value;
    if(!q){ aqiResultList.style.display="none"; return;}
    const results=await nominatimSearch(q);
    renderAqiResults(results);
},300));

// Konumumu Bul (Locate Me) i≈ülevi d√ºzeltildi
aqiLocateBtn.addEventListener('click',()=>{
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async pos=>{
            const lat=pos.coords.latitude;
            const lon=pos.coords.longitude;
            const rev=await nominatimReverse(lat,lon);
            const label=rev && rev.display_name?rev.display_name:`Your Location (${lat.toFixed(3)}, ${lon.toFixed(3)})`;
            aqiAddressInput.value = label;
            goToAqiLocation(lat,lon,label);
            aqiResultList.style.display = 'none';
        },err=>alert("Unable to get your location. Please ensure location services are enabled."));
    }else alert("Geolocation not supported by this browser/device.");
});

aqiClearBtn.addEventListener('click',()=>{
    aqiAddressInput.value="";
    aqiResultList.style.display="none";
    resetAqiDetails("‚Äî");
});


renderRegistered();
renderMyVehicles();
startBackgroundSimulation();
show('home');
</script>
</body>
</html>
