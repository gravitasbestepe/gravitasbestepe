<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GravInAir - Air Quality & Emission Monitor</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
/* Önceki CSS kodları aynı kalacak, sadece last-readings için yeni stil ekliyorum */
.last-readings-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 10px;
    background: #fafafa;
    margin-top: 10px;
}

.reading-item {
    padding: 8px;
    margin-bottom: 6px;
    background: white;
    border-radius: 6px;
    border-left: 4px solid #ddd;
    font-size: 13px;
}

.reading-item.allowed {
    border-left-color: #28a745;
}

.reading-item.limited {
    border-left-color: #ffc107;
}

.reading-item.banned {
    border-left-color: #dc3545;
}

.reading-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 4px;
}

.reading-plate {
    font-weight: bold;
    flex: 1;
}

.reading-status {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
}

.reading-status.allowed {
    background: #d4edda;
    color: #155724;
}

.reading-status.limited {
    background: #fff3cd;
    color: #856404;
}

.reading-status.banned {
    background: #f8d7da;
    color: #721c24;
}

.reading-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4px;
    font-size: 11px;
    color: #666;
}

.reading-value {
    font-weight: bold;
}

.no-readings {
    text-align: center;
    color: #999;
    font-style: italic;
    padding: 20px;
}
</style>
</head>
<body>
<!-- HTML yapısı aynı kalacak -->

<script>
// Last Reading kısmını güncelleyen fonksiyon
function updateHomeScreen() {
    const reg = loadRegistry();
    const t = translations[currentLang] || translations.en;
    
    // Vehicle Status kısmı
    if (reg.length === 0) {
        document.getElementById('vehicleStatus').innerHTML = `<div class="muted">${t.noVehicles}</div>`;
    } else {
        let statusHTML = '';
        let allowed = 0, limited = 0, banned = 0;
        
        reg.forEach(vehicle => {
            if (vehicle.lastRead) {
                const statusClass = getStatusClass(vehicle.lastRead.status);
                statusHTML += `
                    <div style="margin-bottom: 8px;">
                        <strong>${vehicle.plate}</strong>: 
                        <span class="${statusClass}">${vehicle.lastRead.status}</span>
                        <div class="muted" style="font-size: 12px;">PM2.5: ${vehicle.lastRead.pm25}</div>
                    </div>
                `;
                
                if (vehicle.lastRead.status.includes('ALLOWED') && !vehicle.lastRead.status.includes('NOT')) allowed++;
                else if (vehicle.lastRead.status.includes('LIMITED')) limited++;
                else if (vehicle.lastRead.status.includes('NOT ALLOWED') || vehicle.lastRead.status.includes('BANNED')) banned++;
            } else {
                statusHTML += `
                    <div style="margin-bottom: 8px;">
                        <strong>${vehicle.plate}</strong>: 
                        <span class="muted">No reading</span>
                    </div>
                `;
            }
        });
        
        const summary = `
            <div style="background: #f5f5f5; padding: 8px; border-radius: 4px; margin-bottom: 12px; font-size: 12px;">
                <strong>Summary:</strong> 
                <span style="color: green;">${allowed} Allowed</span> | 
                <span style="color: orange;">${limited} Limited</span> | 
                <span style="color: red;">${banned} Banned</span>
            </div>
        `;
        
        document.getElementById('vehicleStatus').innerHTML = summary + statusHTML;
    }
    
    // Last Reading kısmını güncelle - TÜM ARAÇLARIN OKUMALARI
    updateLastReadings();
}

// Tüm araçların son okumalarını gösteren fonksiyon
function updateLastReadings() {
    const reg = loadRegistry();
    const t = translations[currentLang] || translations.en;
    const lastReadContainer = document.getElementById('lastRead');
    
    if (reg.length === 0) {
        lastReadContainer.innerHTML = `<div class="muted">${t.noVehicles}</div>`;
        return;
    }
    
    // Okuması olan araçları filtrele
    const vehiclesWithReadings = reg.filter(vehicle => vehicle.lastRead);
    
    if (vehiclesWithReadings.length === 0) {
        lastReadContainer.innerHTML = `
            <div class="muted">No readings available.</div>
            <div class="last-readings-container">
                <div class="no-readings">No vehicle readings yet</div>
            </div>
        `;
        return;
    }
    
    let readingsHTML = `
        <div class="muted" style="margin-bottom: 8px;">Showing latest readings for all vehicles:</div>
        <div class="last-readings-container">
    `;
    
    // Tüm araçların okumalarını göster
    vehiclesWithReadings.forEach(vehicle => {
        const statusClass = getReadingStatusClass(vehicle.lastRead.status);
        const statusText = getShortStatus(vehicle.lastRead.status, t);
        
        readingsHTML += `
            <div class="reading-item ${statusClass}">
                <div class="reading-header">
                    <span class="reading-plate">${vehicle.plate}</span>
                    <span class="reading-status ${statusClass}">${statusText}</span>
                </div>
                <div class="reading-details">
                    <div>PM2.5: <span class="reading-value">${vehicle.lastRead.pm25}</span></div>
                    <div>PM10: <span class="reading-value">${vehicle.lastRead.pm10}</span></div>
                    <div>CO: <span class="reading-value">${vehicle.lastRead.co}</span></div>
                    <div>Time: <span class="reading-value">${formatTime(vehicle.lastRead.ts)}</span></div>
                </div>
            </div>
        `;
    });
    
    readingsHTML += `</div>`;
    lastReadContainer.innerHTML = readingsHTML;
}

// Okuma durumuna göre CSS class belirle
function getReadingStatusClass(status) {
    if (status?.includes('ALLOWED') && !status?.includes('NOT')) return 'allowed';
    if (status?.includes('LIMITED')) return 'limited';
    if (status?.includes('NOT ALLOWED') || status?.includes('BANNED')) return 'banned';
    return '';
}

// Kısa durum metni
function getShortStatus(status, t) {
    if (status?.includes('ALLOWED') && !status?.includes('NOT')) return 'ALLOWED';
    if (status?.includes('LIMITED')) return 'LIMITED';
    if (status?.includes('NOT ALLOWED') || status?.includes('BANNED')) return 'BANNED';
    return status || 'UNKNOWN';
}

// Zamanı formatla
function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    
    // 1 dakikadan az ise
    if (diff < 60000) {
        return 'Just now';
    }
    
    // 1 saatten az ise
    if (diff < 3600000) {
        const minutes = Math.floor(diff / 60000);
        return `${minutes}m ago`;
    }
    
    // 24 saatten az ise
    if (diff < 86400000) {
        const hours = Math.floor(diff / 3600000);
        return `${hours}h ago`;
    }
    
    // Tarihi göster
    return date.toLocaleTimeString(currentLang, { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
    });
}

// Device read fonksiyonunu güncelle - lastReadings'i de güncellesin
function simulateDeviceRead(index, opts = {}) {
    const reg = loadRegistry();
    if (!reg[index]) return;
    
    const basePM25 = Math.round(Math.random() * 180);
    const pm25 = Math.max(0, Math.round(basePM25 * (opts.multiply || 1)));
    const pm10 = Math.round(pm25 * (0.6 + Math.random() * 0.8));
    const co = (Math.random() * 6).toFixed(2);
    const status = decideStatus(pm25);
    const read = { ts: Date.now(), pm25, pm10, co, status };
    
    reg[index].lastRead = read;
    saveRegistry(reg);
    renderMyVehicles();
    
    // Last Readings'i güncelle
    updateLastReadings();
    
    // Ayrıca küçük bildirim de gösterilebilir
    showReadingNotification(reg[index].plate, pm25, status);
}

// Okuma bildirimi göster
function showReadingNotification(plate, pm25, status) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-left: 4px solid #28a745;
        z-index: 10000;
        max-width: 300px;
        animation: slideIn 0.3s ease;
    `;
    
    // Duruma göre renk
    if (status.includes('BANNED')) {
        notification.style.borderLeftColor = '#dc3545';
    } else if (status.includes('LIMITED')) {
        notification.style.borderLeftColor = '#ffc107';
    }
    
    notification.innerHTML = `
        <strong>${plate}</strong><br>
        PM2.5: <strong>${pm25}</strong><br>
        Status: <strong>${status}</strong>
    `;
    
    document.body.appendChild(notification);
    
    // 3 saniye sonra kaldır
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Animasyon için CSS ekle
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Sayfa yüklendiğinde lastReadings'i de güncelle
function initApp() {
    console.log("Uygulama başlatılıyor...");
    setupEventListeners();
    applyTranslations();
    renderRegistered();
    renderMyVehicles();
    updateHomeScreen(); // Bu zaten updateLastReadings'i çağırıyor
    startBackgroundSimulation();
    loadCountryAQIData();
    show('home');
}

// Quick Read All fonksiyonunu güncelle
function quickReadAll() {
    const reg = loadRegistry();
    const t = translations[currentLang] || translations.en;
    
    if (reg.length === 0) {
        alert(t.noVehicles);
        return;
    }
    
    document.getElementById('quickReadBtn').textContent = t.readingAll;
    document.getElementById('quickReadBtn').disabled = true;
    
    setTimeout(() => {
        for (let i = 0; i < reg.length; i++) {
            simulateDeviceRead(i);
        }
        updateHomeScreen(); // Tüm ekranı güncelle
        document.getElementById('quickReadBtn').textContent = t.quickReadBtn;
        document.getElementById('quickReadBtn').disabled = false;
    }, 1000);
}

// Gradual change fonksiyonunu güncelle
function gradualChange(index, opts = {start: 20, target: 80, steps: 6, interval: 3000}) {
    const reg = loadRegistry();
    if (!reg[index]) return;
    
    let step = 0;
    const start = opts.start;
    const target = opts.target;
    const steps = opts.steps || 6;
    const interval = opts.interval || 3000;
    const delta = (target - start) / steps;
    
    const iv = setInterval(() => {
        step++;
        const currentVal = Math.round(start + delta * step + (Math.random() * 5 - 2));
        const pm25 = Math.max(0, currentVal);
        const pm10 = Math.round(pm25 * (0.6 + Math.random() * 0.8));
        const co = (Math.random() * 6).toFixed(2);
        const status = decideStatus(pm25);
        const read = { ts: Date.now(), pm25, pm10, co, status };
        
        const registry = loadRegistry();
        if (!registry[index]) { 
            clearInterval(iv); 
            return; 
        }
        
        registry[index].lastRead = read;
        saveRegistry(registry);
        renderMyVehicles();
        updateLastReadings(); // Her adımda last readings'i güncelle
        
        if (step >= steps) clearInterval(iv);
    }, interval);
}

// Background simulation'ı güncelle
function startBackgroundSimulation() {
    setInterval(() => {
        const reg = loadRegistry();
        if (!reg.length) return;
        
        for (let i = 0; i < reg.length; i++) {
            if (Math.random() < 0.5) simulateDeviceRead(i);
        }
        renderMyVehicles();
        updateHomeScreen();
    }, 20000);
}
</script>
</body>
</html>
