<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Emission Simulator</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
/* Orijinal CSS korundu */
:root{--bg:#fafafa;--card:#fff;--muted:#666}
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#222}
header{display:flex;align-items:center;gap:12px;padding:10px 14px;background:#0b5;box-shadow:0 2px 8px rgba(0,0,0,.06);flex-wrap:wrap}
header h1{font-size:18px;margin:0}
nav{display:flex;gap:8px;align-items:center}
nav button{background:transparent;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
nav button.active{background:rgba(255,255,255,.9)}
.lang-select{margin-left:auto;display:flex;gap:8px;align-items:center}
.lang-btn{padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.2);background:transparent;cursor:pointer}
.lang-btn.active{background:white}
main{padding:12px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
.card{background:var(--card);padding:10px;border-radius:8px;box-shadow:0 4px 16px rgba(12,12,12,.04)}
#map,#globalMap,#nationalMap{height:420px;border-radius:8px}
/* #aqiControls ve #aqiDetails iÃ§in Ã¶zel stiller eklendi */
#aqiControls { display:flex; gap:6px; align-items:center; flex-wrap:wrap; padding:8px 0; border-bottom:1px solid #eee; margin-bottom: 8px;}
#addressWrapper { flex:1; position:relative; min-width:180px; }
#addressInput { width:100%; padding:5px 38px 5px 8px; font-size:13px; border:1px solid #ccc; border-radius:5px; height:28px; box-sizing:border-box;}
#clearBtn { position:absolute; right:3px; top:50%; transform:translateY(-50%); padding:2px 6px; font-size:12px; border-radius:5px; border:1px solid #bbb; background:white; cursor:pointer; }
#locateBtn { padding:5px 10px; cursor:pointer; border-radius:6px; border:1px solid #bbb; background:white; height:38px; font-size:13px; }
#resultList { position:absolute; left:0; right:0; top:38px; background:white; box-shadow:0 4px 12px rgba(0,0,0,.08); border-radius:5px; z-index:1000; max-height:300px; overflow:auto; display:none; font-size:13px; border:1px solid #ccc; }
.resultItem { padding:6px 8px; border-bottom:1px solid #eee; cursor:pointer; }
.resultItem:hover { background:#f0f7ff; }

#controls{display:flex;gap:6px;align-items:center;flex-wrap:nowrap;padding:8px;background:#f4f4f4;border-radius:8px}
#addressInput{flex:1;padding:6px;border-radius:6px;border:1px solid #ccc}
.resultItem{padding:8px;border-bottom:1px solid #eee;cursor:pointer}
.aqi-bar{height:18px;width:100%;background:#ddd;margin:4px 0;border-radius:5px;overflow:hidden}
.aqi-fill{height:100%;width:0%;background:green;text-align:center;color:white;font-weight:bold;font-size:12px; line-height: 18px;}
label{font-size:13px;color:var(--muted)}
.muted{color:var(--muted);font-size:13px}
.btn{display:inline-block;padding:8px 10px;border-radius:6px;border:1px solid #bbb;background:white;cursor:pointer}
@media(max-width:900px){.grid{grid-template-columns:1fr}#map{height:300px}}
</style>
</head>
<body>
<header>
<h1 id="title">Emission Simulator (Demo)</h1>
<nav>
<button id="nav-home" class="active">Home</button>
<button id="nav-register">Device Register</button>
<button id="nav-vehicle">My Vehicles</button>
<button id="nav-rules">Rules & Advice</button>
<button id="nav-global">Global Emission Map</button>
</nav>
<div class="lang-select" aria-hidden="false">
<button class="lang-btn" data-lang="en" id="lang-en">EN</button>
<button class="lang-btn" data-lang="tr" id="lang-tr">TR</button>
<button class="lang-btn" data-lang="de" id="lang-de">DE</button>
<button class="lang-btn" data-lang="ru" id="lang-ru">RU</button>
</div>
</header>
<main>
<section id="page-home">
<div class="grid">
<div class="card">
<h2 id="home-title">Quick Vehicle Emission Simulator</h2>
<p class="muted" id="home-desc">Register your device and get simulated emission readings here.</p>
<div style="margin-top:10px">
<h3 id="lastReadLabel">Last Reading</h3>
<div id="lastRead" class="muted">No readings yet.</div>
<hr/>
<h3 id="behaviourLabel">System Behaviour</h3>
<p class="muted" id="behaviourText">This demo simulates device readings and traffic eligibility.</p>
</div>
</div>
<aside class="card">
<h3 id="quickAqiTitle">Air Quality Checker (Live Demo)</h3>
<div id="aqiControls">
<div id="addressWrapper">
<input id="addressInput" placeholder="Enter city or address" autocomplete="off" />
<button id="clearBtn">Clear</button>
<div id="resultList"></div>
</div>
<button id="locateBtn">Locate</button>
</div>
<div id="aqiDetails">
<h4 id="locationLabel">Location: â€”</h4>
<div class="aqi-bar"><div id="aqiBar" class="aqi-fill">â€”</div></div>
<p id="aqiText">AQI: â€”</p>
<p id="dominantPollutant">Dominant Pollutant: â€”</p>
<p id="warningMsg" style="color:#b22222; font-weight:bold; font-size:13px; margin-top: 8px;"></p>
<p id="maskMsg" style="color:#0000aa; font-weight:bold; font-size:13px;"></p>
</div>
<hr/>
<div id="miniActions" style="text-align: center;">
<button class="btn" onclick="simulateAllReadsNow()">Simulate All Now</button>
</div>
</aside>
</div>
</section>

<section id="page-register" style="display:none">
<div class="card">
<h2 id="regTitle">Device Register</h2>
<label id="reg_plate_label">Plate</label>
<input id="reg_plate" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc"/>
<label id="reg_device_label">Device ID</label>
<input id="reg_device" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc"/>
<label id="reg_city_label">City</label>
<input id="reg_city" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc"/>
<button id="regBtn" class="btn">Create Register</button>
<hr/>
<h3 id="registeredTitle">Registered Devices</h3>
<div id="registeredList"></div>
</div>
</section>
<section id="page-vehicle" style="display:none">
<div class="card">
<h2 id="myVehiclesTitle">My Vehicles</h2>
<div id="myVehicles"></div>
</div>
</section>
<section id="page-rules" style="display:none">
<div class="card">
<h2 id="rulesTitle">Rules & Advice</h2>
<ul>
<li id="rule1">PM2.5 &gt; 150 => Traffic ban recommended.</li>
<li id="rule2">PM2.5 100-150 => Limited (restricted times).</li>
<li id="rule3">PM2.5 &lt;= 100 => Normal traffic permitted.</li>
</ul>
<h3 id="adviceTitle">Advice</h3>
<ol>
<li id="advice1">Check filters and catalytic converter.</li>
<li id="advice2">Routine maintenance.</li>
<li id="advice3">Reduce idling.</li>
</ol>
</div>
</section>
<section id="page-global" style="display:none">
<div class="card">
<h2 id="globalTitle">Global Emission Hotspots (Simulated)</h2>
<p class="muted" id="globalDesc">Showing simulated dangerous hotspots around the world. Not real data â€” demo only.</p>
<div id="globalMap"></div>
<div id="globalSummary" style="margin-top:8px" class="muted"></div>
</div>
</section>
</main>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ------------------ API Sabitleri ------------------ */
const WAQI_TOKEN="9263e25a74b0d93c30387fa753ec876f19869d38";
const NOMINATIM_BASE="https://nominatim.openstreetmap.org";

/* ------------------ Translations ------------------ */
const translations = {
    en: {
        title: "Emission Simulator (Demo)",
        nav: { home:"Home", register:"Device Register", vehicle:"My Vehicles", rules:"Rules & Advice", global:"Global Emission Map" },
        homeTitle: "Quick Vehicle Emission Simulator",
        homeDesc: "Register your device and get simulated emission readings here.",
        lastReadLabel: "Last Reading", behaviourLabel: "System Behaviour",
        behaviourText: "This demo simulates device readings and traffic eligibility.",
        quickAqiTitle: "Air Quality Checker (Live Demo)", // Yeni
        plateLabel: "Plate (e.g. 34ABC34)", deviceLabel: "Device ID", modelLabel: "Model (optional)", registerBtn: "Register Vehicle",
        regTitle: "Device Register", registeredTitle: "Registered Devices", myVehiclesTitle: "My Vehicles", rulesTitle: "Rules & Advice",
        globalTitle: "Global Emission Hotspots (Simulated)", globalDesc: "Showing simulated dangerous hotspots around the world. Not real data â€” demo only.",
        registerSuccess: "Registration created (demo).", simulateAll: "Simulate All Now",
        // AQI metinleri
        aqiLocation: "Location: â€”", aqiText: "AQI: â€”", aqiPollutant: "Dominant Pollutant: â€”", locateBtn: "Locate",
    },
    tr: {
        title: "Emisyon SimÃ¼latÃ¶rÃ¼ (Demo)",
        nav: { home:"Anasayfa", register:"Cihaz KayÄ±t", vehicle:"AraÃ§larÄ±m", rules:"Kurallar & Ã–neriler", global:"Global Emisyon HaritasÄ±" },
        homeTitle: "HÄ±zlÄ± AraÃ§ Emisyon SimÃ¼latÃ¶rÃ¼",
        homeDesc: "CihazÄ±nÄ±zÄ± kaydedin ve simÃ¼le emisyon okumalarÄ± alÄ±n.",
        lastReadLabel: "Son Okuma", behaviourLabel: "Sistem DavranÄ±ÅŸÄ±",
        behaviourText: "Bu demo, cihaz okumalarÄ±nÄ± ve trafik uygunluÄŸunu simÃ¼le eder.",
        quickAqiTitle: "Hava Kalitesi Denetleyicisi (CanlÄ± Demo)", // Yeni
        plateLabel: "Plaka (Ã¶r: 34ABC34)", deviceLabel: "Cihaz ID", modelLabel: "Model (isteÄŸe baÄŸlÄ±)", registerBtn: "AraÃ§ Kaydet",
        regTitle: "Cihaz KayÄ±t", registeredTitle: "KayÄ±tlÄ± Cihazlar", myVehiclesTitle: "AraÃ§larÄ±m", rulesTitle: "Kurallar & Ã–neriler",
        globalTitle: "Global Emisyon Tehlike NoktalarÄ± (SimÃ¼le)", globalDesc: "DÃ¼nya Ã§apÄ±ndaki tehlikeli noktalarÄ±n simÃ¼le gÃ¶sterimi. GerÃ§ek veri deÄŸil â€” demo.",
        registerSuccess: "KayÄ±t oluÅŸturuldu (demo).", simulateAll: "TÃ¼mÃ¼nÃ¼ SimÃ¼le Et",
        // AQI metinleri
        aqiLocation: "Konum: â€”", aqiText: "HKÄ°: â€”", aqiPollutant: "BaskÄ±n Kirletici: â€”", locateBtn: "Konumumu Bul",
    },
    // DiÄŸer diller de benzer ÅŸekilde gÃ¼ncellenebilir.
    de: { /* ... */ },
    ru: { /* ... */ }
};

let lang = localStorage.getItem('site_lang') || 'en';

/* ------------------ SPA navigation ------------------ */
const pages = {
    home: document.getElementById('page-home'),
    register: document.getElementById('page-register'),
    vehicle: document.getElementById('page-vehicle'),
    rules: document.getElementById('page-rules'),
    global: document.getElementById('page-global')
};
function show(page){
    Object.values(pages).forEach(p => p.style.display = 'none');
    pages[page].style.display = 'block';
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById('nav-' + page).classList.add('active');
    // initialize maps if needed
    if (page === 'global') {
        setTimeout(() => { initGlobalMap(); if (window.globalMap) window.globalMap.invalidateSize(); }, 200);
    }
}
document.getElementById('nav-home').addEventListener('click', ()=>show('home'));
document.getElementById('nav-register').addEventListener('click', ()=>show('register'));
document.getElementById('nav-vehicle').addEventListener('click', ()=>show('vehicle'));
document.getElementById('nav-rules').addEventListener('click', ()=>show('rules'));
document.getElementById('nav-global').addEventListener('click', ()=>show('global'));

/* ------------------ Language UI ------------------ */
function setLanguage(l){
    lang = l;
    localStorage.setItem('site_lang', l);
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.dataset.lang === l));
    applyTranslations();
}
document.querySelectorAll('.lang-btn').forEach(b => {
    b.addEventListener('click', ()=>setLanguage(b.dataset.lang));
});
// on load apply language
setLanguage(lang);

function applyTranslations(){
    const t = translations[lang] || translations.en;
    document.getElementById('title').textContent = t.title;
    // nav
    document.getElementById('nav-home').textContent = t.nav.home;
    document.getElementById('nav-register').textContent = t.nav.register;
    document.getElementById('nav-vehicle').textContent = t.nav.vehicle;
    document.getElementById('nav-rules').textContent = t.nav.rules;
    document.getElementById('nav-global').textContent = t.nav.global;
    // home
    document.getElementById('home-title').textContent = t.homeTitle;
    document.getElementById('home-desc').textContent = t.homeDesc;
    document.getElementById('lastReadLabel').textContent = t.lastReadLabel;
    document.getElementById('behaviourLabel').textContent = t.behaviourLabel;
    document.getElementById('behaviourText').textContent = t.behaviourText;
    // quick AQI labels
    document.getElementById('quickAqiTitle').textContent = t.quickAqiTitle;
    document.getElementById('locateBtn').textContent = t.locateBtn;
    document.getElementById('locationLabel').textContent = t.aqiLocation;
    document.getElementById('aqiText').textContent = t.aqiText;
    document.getElementById('dominantPollutant').textContent = t.aqiPollutant;

    // quick register (eski, artÄ±k kullanÄ±lmÄ±yor ama kodda kalabilir)
    // document.getElementById('plateLabel').textContent = t.plateLabel;
    // document.getElementById('deviceLabel').textContent = t.deviceLabel;
    // document.getElementById('modelLabel').textContent = t.modelLabel;
    // document.getElementById('registerVehicleBtn').textContent = t.registerBtn;
    document.getElementById('regTitle').textContent = t.regTitle;
    document.getElementById('registeredTitle').textContent = t.registeredTitle;
    document.getElementById('myVehiclesTitle').textContent = t.myVehiclesTitle;
    document.getElementById('rulesTitle').textContent = t.rulesTitle;
    document.getElementById('globalTitle').textContent = t.globalTitle;
    document.getElementById('globalDesc').textContent = t.globalDesc;
    // simulate button
    document.querySelector('#miniActions .btn').textContent = t.simulateAll;
}

/* ------------------ Registry + Simulation (localStorage demo, hooks for backend) ------------------ */
function loadRegistry(){
    try{ return JSON.parse(localStorage.getItem('emission_registry')||'[]'); } catch(e){ return []; }
}
function saveRegistry(reg){
    localStorage.setItem('emission_registry', JSON.stringify(reg));
}
function renderRegistered(){
    const list = document.getElementById('registeredList');
    const reg = loadRegistry();
    if(!list) return;
    if(reg.length === 0){ list.innerHTML = '<div class="muted">No devices.</div>'; return; }
    list.innerHTML = '';
    reg.forEach(r => {
        const div = document.createElement('div');
        div.style.padding='8px';
        div.style.borderBottom='1px solid #eee';
        div.innerHTML = `<strong>${r.plate}</strong> â€” ${r.device} <div class="muted">${r.city || ''}</div>`;
        list.appendChild(div);
    });
}
function renderMyVehicles(){
    const cont = document.getElementById('myVehicles');
    const reg = loadRegistry();
    if(!cont) return;
    if(reg.length === 0){ cont.innerHTML = '<div class="muted">No vehicles.</div>'; return; }
    cont.innerHTML = '';
    reg.forEach((r, idx) => {
        const box = document.createElement('div');
        box.style.border='1px solid #eee';
        box.style.padding='8px';
        box.style.borderRadius='6px';
        box.style.marginBottom='8px';
        const last = r.lastRead ? `<div>PM2.5: <strong>${r.lastRead.pm25}</strong> â€” Status: <strong>${r.lastRead.status}</strong></div>` : '<div class="muted">No readings yet.</div>';
        box.innerHTML = `<strong>${r.plate}</strong> â€” ${r.device}<div class="muted">${r.model||''} ${r.city?'- '+r.city:''}</div>${last}<div style="margin-top:8px"><button class="btn" data-idx="${idx}" onclick="forceRead(this)">Manual Read</button> <button class="btn" data-idx="${idx}" onclick="simulateTrip(this)">Simulate Trip</button></div>`;
        cont.appendChild(box);
    });
}
// KayÄ±t bÃ¶lÃ¼mÃ¼ butonu (orijinal koddan)
document.getElementById('regBtn').addEventListener('click', ()=>{
    const plate = document.getElementById('reg_plate').value.trim();
    const device = document.getElementById('reg_device').value.trim();
    const city = document.getElementById('reg_city').value.trim();
    if(!plate || !device){ alert('Plate and device required'); return; }
    const reg = loadRegistry();
    reg.push({ plate, device, city, created: Date.now(), lastRead: null });
    saveRegistry(reg);
    renderRegistered();
    renderMyVehicles();
    alert(translations[lang].registerSuccess);
    // start gradual initial readings
    const idx = reg.length - 1;
    gradualChange(idx, { start: 20, target: Math.round(Math.random()*140+10), steps: 6, interval: 2500 });
});
// Anasayfa hÄ±zlÄ± kayÄ±t butonu (orijinal koddan, artÄ±k HOME'da gÃ¶rÃ¼nmÃ¼yor ama JS'te kaldÄ±)
/*
document.getElementById('registerVehicleBtn').addEventListener('click', ()=>{
    const plate = document.getElementById('plateInput').value.trim();
    const device = document.getElementById('deviceInput').value.trim();
    const model = document.getElementById('modelInput').value.trim();
    if(!plate || !device){ alert('Plate and device required'); return; }
    const reg = loadRegistry();
    reg.push({ plate, device, model, created: Date.now(), lastRead: null });
    saveRegistry(reg);
    document.getElementById('lastRead').textContent = 'Registered: ' + plate;
    document.getElementById('plateInput').value='';
    document.getElementById('deviceInput').value='';
    document.getElementById('modelInput').value='';
    renderRegistered();
    renderMyVehicles();
    const idx = loadRegistry().length - 1;
    gradualChange(idx, { start:20, target: Math.round(Math.random()*140+10), steps:6, interval:2500 });
});
*/
window.forceRead = function(btn){
    const idx = parseInt(btn.dataset.idx);
    simulateDeviceRead(idx);
}
window.simulateTrip = function(btn){
    const idx = parseInt(btn.dataset.idx);
    const reg = loadRegistry();
    if(!reg[idx]) return;
    gradualChange(idx, {
        start: reg[idx].lastRead ? reg[idx].lastRead.pm25 : 30,
        target: Math.min(400, Math.round((reg[idx].lastRead?reg[idx].lastRead.pm25:30) * (1.6 + Math.random()*0.6))),
        steps: 8, interval: 3000
    });
}
function simulateDeviceRead(index, opts = {}){
    const reg = loadRegistry();
    if(!reg[index]) return;
    const basePM25 = Math.round(Math.random()*180);
    const pm25 = Math.max(0, Math.round(basePM25 * (opts.multiply||1)));
    const pm10 = Math.round(pm25 * (0.6 + Math.random()*0.8));
    const co = (Math.random()*6).toFixed(2);
    const status = decideStatus(pm25);
    const read = { ts: Date.now(), pm25, pm10, co, status };
    reg[index].lastRead = read;
    saveRegistry(reg);
    renderMyVehicles();
    document.getElementById('lastRead').innerHTML = `${reg[index].plate} â€” PM2.5: ${pm25} â€” ${status}`;
}
function decideStatus(pm25){
    if(pm25 > 150) return 'TRAFFIC NOT ALLOWED';
    if(pm25 > 100) return 'LIMITED (RESTRICTED TIMES)';
    return 'TRAFFIC ALLOWED';
}
function gradualChange(index, opts={start:20,target:80,steps:6,interval:3000}){
    const reg = loadRegistry();
    if(!reg[index]) return;
    let step = 0;
    const start = opts.start;
    const target = opts.target;
    const steps = opts.steps||6;
    const interval = opts.interval||3000;
    const delta = (target - start) / steps;
    const iv = setInterval(()=>{
        step++;
        const currentVal = Math.round(start + delta*step + (Math.random()*5-2));
        const pm25 = Math.max(0, currentVal);
        const pm10 = Math.round(pm25 * (0.6 + Math.random()*0.8));
        const co = (Math.random()*6).toFixed(2);
        const status = decideStatus(pm25);
        const read = { ts: Date.now(), pm25, pm10, co, status };
        const registry = loadRegistry();
        if(!registry[index]){ clearInterval(iv); return; }
        registry[index].lastRead = read;
        saveRegistry(registry);
        renderMyVehicles();
        document.getElementById('lastRead').innerHTML = `${registry[index].plate} â€” PM2.5: ${pm25} â€” ${status}`;
        if(step >= steps) clearInterval(iv);
    }, interval);
}

/* ------------------ Periodic background simulation (demo) ------------------ */
function startBackgroundSimulation(){
    setInterval(()=>{
        const reg = loadRegistry();
        if(!reg.length) return;
        for(let i=0;i<reg.length;i++){
            if(Math.random() < 0.5) simulateDeviceRead(i);
        }
        renderMyVehicles();
    }, 20000);
}

/* ------------------ Global map (world hotspots) ------------------ */
let globalMap = null;
function initGlobalMap(){
    if(globalMap) return; // already created
    globalMap = L.map('globalMap').setView([20,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(globalMap);
    // Simulated global hotspots - give emphasis to infamous polluted areas
    const hotspots = [
        {name:'Delhi, India', lat:28.7041, lon:77.1025, pm25: 320},
        {name:'Beijing, China', lat:39.9042, lon:116.4074, pm25: 280},
        {name:'Lahore, Pakistan', lat:31.5204, lon:74.3587, pm25: 260},
        {name:'Dhaka, Bangladesh', lat:23.8103, lon:90.4125, pm25: 240},
        {name:'Karachi, Pakistan', lat:24.8607, lon:67.0011, pm25: 220},
        {name:'Ulaanbaatar, Mongolia', lat:47.8864, lon:106.9057, pm25: 300},
        {name:'Mexico City, Mexico', lat:19.4326, lon:-99.1332, pm25: 180},
        {name:'Silesia, Poland (industrial)', lat:50.3, lon:18.7, pm25: 190},
        {name:'Los Angeles, USA (urban)', lat:34.05, lon:-118.24, pm25: 110},
        {name:'Moscow, Russia', lat:55.7558, lon:37.6176, pm25: 100},
        {name:'Istanbul, Turkey', lat:41.0, lon:28.97, pm25: 120}
    ];
    hotspots.forEach(h=>{
        const color = getColorForPM25(h.pm25);
        const marker = L.circle([h.lat,h.lon], {
            radius: Math.min(50000, h.pm25*300),
            color, fillColor: color, fillOpacity:0.5
        }).addTo(globalMap);
        marker.bindPopup(`<strong>${h.name}</strong><br>Simulated PM2.5: ${h.pm25}`);
    });
    document.getElementById('globalSummary').innerHTML = '<div class="muted">Hotspots shown are simulated and only for demo purposes.</div>';
}
function getColorForPM25(v){
    if(v<=50) return 'green';
    if(v<=100) return 'yellow';
    if(v<=150) return 'orange';
    if(v<=200) return 'red';
    if(v<=300) return 'purple';
    return 'maroon';
}

/* ------------------ AQI Checker Entegrasyonu ------------------ */
const addressInput=document.getElementById('addressInput');
const resultList=document.getElementById('resultList');
const locateBtn=document.getElementById('locateBtn');
const clearBtn=document.getElementById('clearBtn');
const locationLabel=document.getElementById('locationLabel');
const aqiBar=document.getElementById('aqiBar');
const aqiText=document.getElementById('aqiText');
const dominantPollutant=document.getElementById('dominantPollutant');
const warningMsg=document.getElementById('warningMsg');
const maskMsg=document.getElementById('maskMsg');

function debounce(fn,wait){let t;return function(...args){clearTimeout(t);t=setTimeout(()=>fn.apply(this,args),wait);};}

async function nominatimSearch(q){
    // Nominatim'den arama sonuÃ§larÄ±nÄ± al
    const res=await fetch(`${NOMINATIM_BASE}/search?format=json&addressdetails=1&limit=10&q=${encodeURIComponent(q)}`,{headers:{'Accept-Language':'en'}});
    return res.json();
}

async function selectResult(item){
    resultList.style.display='none';
    addressInput.value=item.display_name;
    // Harita olmadÄ±ÄŸÄ± iÃ§in sadece AQI'ya git
    fetchAQI(parseFloat(item.lat),parseFloat(item.lon),item.display_name);
}

function renderResults(items){
    resultList.innerHTML="";
    if(!items||items.length===0){resultList.style.display="none";return;}
    items.forEach(item=>{
        const div=document.createElement('div');
        div.className='resultItem';
        div.innerHTML=`<strong>${item.display_name}</strong>`;
        div.tabIndex=0;
        div.addEventListener('click',()=>selectResult(item));
        div.addEventListener('keydown',(e)=>{if(e.key==='Enter')selectResult(item);});
        resultList.appendChild(div);
    });
    resultList.style.display='block';
}

function updateAQIUI(data,label){
    const t = translations[lang] || translations.en;
    locationLabel.textContent=`${t.aqiLocation.replace(/:\sâ€”/g, '')}: ${label||'â€”'}`;
    const aqi=data&&data.aqi?data.aqi:null;
    aqiText.textContent=`${t.aqiText.replace(/:\sâ€”/g, '')}: ${aqi!==null?aqi:'â€”'}`;
    dominantPollutant.textContent=`${t.aqiPollutant.replace(/:\sâ€”/g, '')}: ${((data&&data.dominentpol)?data.dominentpol.toUpperCase():'â€”')}`;

    let color="#999";
    let warning="",mask="";
    const percent = aqi===null?0:Math.min(aqi,500)/500*100;

    if(aqi===null){warning="";mask="";}
    else if(aqi<=50){color="green"; warning="âœ… Air quality is good for everyone.";mask="";}
    else if(aqi<=100){color="yellow"; warning="âš ï¸ Moderate. Sensitive people should take care.";mask="";}
    else if(aqi<=150){color="orange"; warning="âš ï¸ Unhealthy for sensitive groups. Limit outdoor activity.";mask="Consider wearing a mask if you have respiratory conditions.";}
    else if(aqi<=200){color="red"; warning="âŒ Unhealthy. Avoid outdoor exercise.";mask="Wear a mask if going outside.";}
    else if(aqi<=300){color="purple"; warning="â˜ ï¸ Very unhealthy. Everyone should stay indoors.";mask="Use a high-quality mask if you must go out.";}
    else{color="maroon"; warning="ðŸš« Hazardous. Stay indoors.";mask="Wear a mask and use air purifier.";}

    aqiBar.style.background=color;
    aqiBar.style.width=percent+"%";
    aqiBar.textContent=(aqi===null?'â€”':aqi);
    warningMsg.textContent=warning;
    maskMsg.textContent=mask;
}

async function fetchAQI(lat,lon,label){
    try{
        // AQI detaylarÄ±nÄ± sÄ±fÄ±rla
        updateAQIUI(null, label);
        const res=await fetch(`https://api.waqi.info/feed/geo:${lat};${lon}/?token=${WAQI_TOKEN}`);
        const resp=await res.json();
        if(resp.status==="ok")updateAQIUI(resp.data,label);
        else alert("AQI data not available for this location.");
    }catch(err){alert("Error fetching AQI data."); console.error(err);}
}

// Olay dinleyicileri
addressInput.addEventListener('input',debounce(async()=>{
    const q=addressInput.value;
    if(!q){ resultList.style.display="none"; return;}
    const results=await nominatimSearch(q);
    renderResults(results);
},300));

locateBtn.addEventListener('click',()=>{
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async pos=>{
            const lat=pos.coords.latitude;
            const lon=pos.coords.longitude;
            // Nominatim reverse lookup'a gerek yok, doÄŸrudan koordinatlarla sorgulayabiliriz
            const label=`Your Location (${lat.toFixed(3)}, ${lon.toFixed(3)})`;
            addressInput.value = label;
            fetchAQI(lat,lon,label);
        },err=>alert("Unable to get your location."));
    }else alert("Geolocation not supported.");
});

clearBtn.addEventListener('click',()=>{
    addressInput.value="";
    resultList.style.display="none";
    updateAQIUI(null, "â€”");
});

/* ------------------ Init ------------------ */
renderRegistered();
renderMyVehicles();
startBackgroundSimulation();
show('home'); // default page
// Expose small debug utility
window.simulateAllReadsNow = function(){
    const reg = loadRegistry();
    for(let i=0;i<reg.length;i++) simulateDeviceRead(i);
    renderMyVehicles();
};
</script>
</body>
</html>
