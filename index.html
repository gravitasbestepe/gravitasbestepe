<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Emission Simulator + Real AQI</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  :root{--bg:#fafafa;--card:#fff;--muted:#666}
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#222}
  header{display:flex;align-items:center;gap:12px;padding:10px 14px;background:#0b5;box-shadow:0 2px 8px rgba(0,0,0,.06);flex-wrap:wrap}
  header h1{font-size:18px;margin:0}
  nav{display:flex;gap:8px;align-items:center}
  nav button{background:transparent;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
  nav button.active{background:rgba(255,255,255,.9)}
  .lang-select{margin-left:auto;display:flex;gap:8px;align-items:center}
  .lang-btn{padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.2);background:transparent;cursor:pointer}
  .lang-btn.active{background:white}
  main{padding:12px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .card{background:var(--card);padding:10px;border-radius:8px;box-shadow:0 4px 16px rgba(12,12,12,.04)}
  #map,#globalMap,#nationalMap{height:420px;border-radius:8px}
  #controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap;padding:8px;background:#f4f4f4;border-radius:8px}
  #addressWrapper{flex:1;position:relative;min-width:200px;}
  #addressInput{width:100%;padding:5px 38px 5px 8px;font-size:13px;border:1px solid #ccc;border-radius:5px;height:28px;}
  #clearBtn{position:absolute;right:3px;top:50%;transform:translateY(-50%);padding:2px 6px;font-size:12px;border-radius:5px;border:1px solid #bbb;background:white;cursor:pointer;}
  #locateBtn{padding:5px 10px;cursor:pointer;border-radius:5px;border:1px solid #bbb;background:white;height:28px;}
  #resultList{position:absolute;left:0;right:0;top:30px;background:white;box-shadow:0 4px 12px rgba(0,0,0,.08);border-radius:5px;z-index:1000;max-height:300px;overflow:auto;display:none;font-size:13px;}
  .resultItem{padding:6px 8px;border-bottom:1px solid #eee;cursor:pointer;}
  .resultItem:hover{background:#f0f7ff;}
  #aqiDetails{padding:10px;background:white;margin-top:12px;}
  .aqi-bar{height:18px;width:100%;background:#ddd;margin:4px 0;border-radius:5px;overflow:hidden}
  .aqi-fill{height:100%;width:0%;background:green;text-align:center;color:white;font-weight:bold;font-size:12px}
  ul#pollutants{margin:0;padding-left:18px;font-size:12px;}
  @media(max-width:900px){.grid{grid-template-columns:1fr}#map{height:300px}}
</style>
</head>
<body>
<header>
  <h1 id="title">Emission Simulator + Real AQI</h1>
  <nav>
    <button id="nav-home" class="active">Home</button>
    <button id="nav-register">Device Register</button>
    <button id="nav-vehicle">My Vehicles</button>
    <button id="nav-rules">Rules & Advice</button>
    <button id="nav-global">Global Emission Map</button>
  </nav>
</header>
<main>
  <section id="page-home">
    <div class="grid">
      <div class="card">
        <h2>Quick Vehicle Emission Simulator</h2>
        <p class="muted">Register your device and get simulated emission readings here.</p>
        <div id="lastRead">No readings yet.</div>
        <hr/>
        <h3>System Behaviour</h3>
        <p class="muted">This demo simulates device readings and traffic eligibility.</p>

        <div id="controls" style="margin-top:12px">
          <div id="addressWrapper">
            <input id="addressInput" placeholder="Enter city, street, or address" autocomplete="off"/>
            <button id="clearBtn">Clear</button>
            <div id="resultList"></div>
          </div>
          <button id="locateBtn">Locate Me</button>
        </div>
        <div id="map"></div>
        <div id="aqiDetails">
          <h3 id="locationLabel">Location: â€”</h3>
          <div class="aqi-bar"><div id="aqiBar" class="aqi-fill">â€”</div></div>
          <p id="aqiText">AQI: â€”</p>
          <p id="dominantPollutant">Dominant Pollutant: â€”</p>
          <ul id="pollutants"></ul>
          <p id="warningMsg" style="color:#b22222; font-weight:bold;"></p>
          <p id="maskMsg" style="color:#0000aa; font-weight:bold;"></p>
        </div>
      </div>
      <aside class="card">
        <h3>Quick Register</h3>
        <label>Plate</label>
        <input id="plateInput" placeholder="Enter plate"/>
        <label>Device ID</label>
        <input id="deviceInput" placeholder="Device ID"/>
        <label>Model (optional)</label>
        <input id="modelInput" placeholder="Model"/>
        <button id="registerVehicleBtn" class="btn" style="width:100%;margin-top:6px">Register Vehicle</button>
      </aside>
    </div>
  </section>
</main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const WAQI_TOKEN="9263e25a74b0d93c30387fa753ec876f19869d38";
const NOMINATIM_BASE="https://nominatim.openstreetmap.org";

// Map initialization
const map=L.map('map').setView([39.925,32.866],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let marker=null;

// UI references
const addressInput=document.getElementById('addressInput');
const resultList=document.getElementById('resultList');
const locateBtn=document.getElementById('locateBtn');
const clearBtn=document.getElementById('clearBtn');
const locationLabel=document.getElementById('locationLabel');
const aqiBar=document.getElementById('aqiBar');
const aqiText=document.getElementById('aqiText');
const dominantPollutant=document.getElementById('dominantPollutant');
const pollutantsEl=document.getElementById('pollutants');
const warningMsg=document.getElementById('warningMsg');
const maskMsg=document.getElementById('maskMsg');

// Debounce helper
function debounce(fn,wait){let t;return function(...args){clearTimeout(t);t=setTimeout(()=>fn.apply(this,args),wait);};}

// Nominatim geocoding
async function nominatimSearch(q){
  const res=await fetch(`${NOMINATIM_BASE}/search?format=json&addressdetails=1&limit=25&q=${encodeURIComponent(q)}`,{headers:{'Accept-Language':'en'}});
  return res.json();
}
async function nominatimReverse(lat,lon){
  const res=await fetch(`${NOMINATIM_BASE}/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`,{headers:{'Accept-Language':'en'}});
  return res.json();
}

function renderResults(items){
  resultList.innerHTML="";
  if(!items||items.length===0){resultList.style.display="none";return;}
  items.forEach(item=>{
    const div=document.createElement('div');
    div.className='resultItem';
    div.innerHTML=`<strong>${item.display_name}</strong>`;
    div.dataset.lat=item.lat;
    div.dataset.lon=item.lon;
    div.dataset.display=item.display_name;
    div.addEventListener('click',()=>selectResult(item));
    div.addEventListener('keydown',(e)=>{if(e.key==='Enter')selectResult(item);});
    resultList.appendChild(div);
  });
  resultList.style.display='block';
}

async function selectResult(item){
  resultList.style.display='none';
  addressInput.value=item.display_name;
  goToLocation(parseFloat(item.lat),parseFloat(item.lon),item.display_name);
}

function setMarker(lat,lon){
  if(marker) map.removeLayer(marker);
  marker=L.marker([lat,lon]).addTo(map);
  map.setView([lat,lon],15);
}

// Fetch AQI
async function fetchAQI(lat,lon,label){
  try{
    const res=await fetch(`https://api.waqi.info/feed/geo:${lat};${lon}/?token=${WAQI_TOKEN}`);
    const resp=await res.json();
    if(resp.status==="ok") updateAQIUI(resp.data,label);
    else alert("AQI data not available for this location.");
  }catch(err){alert("Error fetching AQI data."); console.error(err);}
}

// Update AQI UI
function updateAQIUI(data,label){
  locationLabel.textContent="Location: "+(label||'â€”');
  const aqi=data&&data.aqi?data.aqi:null;
  aqiText.textContent="AQI: "+(aqi!==null?aqi:'â€”');
  dominantPollutant.textContent="Dominant Pollutant: "+((data&&data.dominentpol)?data.dominentpol.toUpperCase():'â€”');
  let color="green";
  if(aqi===null) color="#999";
  else if(aqi<=50) color="green";
  else if(aqi<=100) color="yellow";
  else if(aqi<=150) color="orange";
  else if(aqi<=200) color="red";
  else if(aqi<=300) color="purple";
  else color="maroon";
  aqiBar.style.background=color;
  aqiBar.style.width=(aqi===null?0:Math.min(aqi,500)/500*100)+"%";
  aqiBar.textContent=(aqi===null?'â€”':aqi);
  pollutantsEl.innerHTML="";
  const keys=["co","h","no2","o3","p","pm10","pm25","so2","t","w"];
  if(data&&data.iaqi){keys.forEach(k=>{if(data.iaqi[k]){const li=document.createElement('li');li.textContent=`${k.toUpperCase()}: ${data.iaqi[k].v}`;pollutantsEl.appendChild(li);}})}
  let warning="",mask="";
  if(aqi===null){} 
  else if(aqi<=50){warning="âœ… Air quality is good for everyone.";}
  else if(aqi<=100){warning="âš ï¸ Moderate. Sensitive people should take care.";}
  else if(aqi<=150){warning="âš ï¸ Unhealthy for sensitive groups. Limit outdoor activity.";mask="Consider wearing a mask if you have respiratory conditions.";}
  else if(aqi<=200){warning="âŒ Unhealthy. Avoid outdoor exercise.";mask="Wear a mask if going outside.";}
  else if(aqi<=300){warning="â˜ ï¸ Very unhealthy. Everyone should stay indoors.";mask="Use a high-quality mask if you must go out.";}
  else{warning="ðŸš« Hazardous. Stay indoors.";mask="Wear a mask and use air purifier.";}
  warningMsg.textContent=warning;
  maskMsg.textContent=mask;
}

async function goToLocation(lat,lon,label){setMarker(lat,lon);fetchAQI(lat,lon,label);}

// Event listeners
addressInput.addEventListener('input',debounce(async()=>{
  const q=addressInput.value; if(!q)return;
  const results=await nominatimSearch(q); renderResults(results);
},250));

locateBtn.addEventListener('click',()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      const lat=pos.coords.latitude;
      const lon=pos.coords.longitude;
      const rev=await nominatimReverse(lat,lon);
      const label=rev && rev.display_name?rev.display_name:`Your Location (${lat.toFixed(3)}, ${lon.toFixed(3)})`;
      goToLocation(lat,lon,label);
    },err=>alert("Unable to get your location."));
  } else alert("Geolocation not supported.");
});

clearBtn.addEventListener('click',()=>{addressInput.value="";resultList.style.display="none";});

map.on('click',function(e){const lat=e.latlng.lat;const lon=e.latlng.lng;goToLocation(lat,lon,`Selected Point (${lat.toFixed(3)}, ${lon.toFixed(3)})`);});
</script>
</body>
</html>
