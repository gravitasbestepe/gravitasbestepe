<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Emission Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body { font-family: Arial; margin:0; padding:0; background:#fafafa; color:#222; }
#controls { display:flex; gap:6px; align-items:center; padding:8px; background:#f4f4f4; flex-wrap:wrap; }
#map { height:50vh; margin:10px 0; }
#vehicleList, #adminPanel { padding:10px; background:white; margin:10px; border-radius:5px; }
input, button { padding:5px; margin:2px; }
table { border-collapse:collapse; width:100%; }
th, td { border:1px solid #ccc; padding:4px; text-align:center; }
</style>
</head>
<body>

<div id="controls">
  <button id="googleLogin">Google ile Giriş</button>
  <span id="userInfo">Henüz giriş yapılmadı</span>
</div>

<div id="vehicleList">
  <h3>Araç Kayıt Formu</h3>
  <input type="text" id="plate" placeholder="Plaka"/>
  <input type="number" id="emission" placeholder="Emisyon (g/km)"/>
  <input type="text" id="city" placeholder="Şehir"/>
  <button id="addVehicle">Kaydet</button>
  <p id="status"></p>
</div>

<div id="adminPanel">
  <h3>Admin Panel - Kayıtlı Araçlar</h3>
  <table id="vehicleTable">
    <thead>
      <tr><th>Plaka</th><th>Emisyon</th><th>Şehir</th><th>Tarih</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAPz1mkEVT0QG_COEQxZti5l6b2dQkII54",
  authDomain: "gravinair-a9928.firebaseapp.com",
  projectId: "gravinair-a9928",
  storageBucket: "gravinair-a9928.appspot.com",
  messagingSenderId: "402929247815",
  appId: "1:402929247815:web:08962ac9a8bf9331267362"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// Map
const map = L.map('map').setView([0,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// Login
const loginBtn = document.getElementById("googleLogin");
const userInfo = document.getElementById("userInfo");

loginBtn.addEventListener("click", async ()=>{
  try{
    const result = await signInWithPopup(auth, provider);
    userInfo.textContent = "Hoşgeldin: " + result.user.displayName;
    loadVehicles();
  }catch(err){console.error(err);}
});

onAuthStateChanged(auth,user=>{
  if(user) userInfo.textContent = "Hoşgeldin: " + user.displayName;
  else userInfo.textContent = "Henüz giriş yapılmadı";
});

// Add Vehicle
document.getElementById("addVehicle").addEventListener("click", async ()=>{
  const plate = document.getElementById("plate").value.toUpperCase();
  const emission = parseFloat(document.getElementById("emission").value);
  const city = document.getElementById("city").value;
  const status = document.getElementById("status");

  if(!plate || isNaN(emission) || !city){ status.textContent="Lütfen tüm alanları doldur!"; return;}

  try{
    await addDoc(collection(db,"vehicles"),{
      plate, emission, city, date:new Date().toISOString()
    });
    status.textContent = "Araç kaydedildi!";
    document.getElementById("plate").value="";
    document.getElementById("emission").value="";
    document.getElementById("city").value="";
    loadVehicles();
  }catch(err){console.error(err); status.textContent="Hata oluştu!";}
});

// Load Vehicles
async function loadVehicles(){
  const tbody = document.querySelector("#vehicleTable tbody");
  tbody.innerHTML="";
  const snapshot = await getDocs(collection(db,"vehicles"));
  snapshot.forEach(doc=>{
    const v = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${v.plate}</td><td>${v.emission}</td><td>${v.city}</td><td>${new Date(v.date).toLocaleString()}</td>`;
    tbody.appendChild(tr);

    // Map marker (simüle rastgele koordinat)
    const lat =  Math.random()*140-70; 
    const lon = Math.random()*360-180; 
    L.circle([lat,lon],{radius:v.emission*50,color:"red"}).addTo(map)
      .bindPopup(`Plaka: ${v.plate}<br>Emisyon: ${v.emission} g/km<br>Şehir: ${v.city}`);
  });
}

// İlk yüklemede
loadVehicles();
</script>
</body>
</html>
