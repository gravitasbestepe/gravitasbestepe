<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Air Quality + Araç Emisyon Simülatörü</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  :root{--bg:#fafafa;--card:#fff;--muted:#666}
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#222}
  header{display:flex;align-items:center;gap:12px;padding:10px 14px;background:#0b5;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  header h1{font-size:18px;margin:0}
  nav{display:flex;gap:8px}
  nav button{background:transparent;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
  nav button.active{background:rgba(255,255,255,.9)}
  main{padding:12px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .card{background:var(--card);padding:10px;border-radius:8px;box-shadow:0 4px 16px rgba(12,12,12,.04)}
  #map{height:420px;border-radius:8px}
  #controls{display:flex;gap:6px;align-items:center;flex-wrap:nowrap;padding:8px;background:#f4f4f4;border-radius:8px}
  #addressInput{flex:1;padding:6px;border-radius:6px;border:1px solid #ccc}
  #resultList{position:absolute;left:0;right:0;top:36px;background:white;box-shadow:0 6px 18px rgba(0,0,0,.08);border-radius:6px;z-index:1000;max-height:220px;overflow:auto;display:none}
  .resultItem{padding:8px;border-bottom:1px solid #eee;cursor:pointer}
  .resultItem:hover{background:#f0f7ff}
  .aqi-bar{height:18px;width:100%;background:#ddd;margin:4px 0;border-radius:5px;overflow:hidden}
  .aqi-fill{height:100%;width:0%;background:green;text-align:center;color:white;font-weight:bold;font-size:12px}
  label{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted);font-size:13px}
  .btn{display:inline-block;padding:8px 10px;border-radius:6px;border:1px solid #bbb;background:white;cursor:pointer}
  .danger{background:#ffdddd;border-color:#ff9999}
  /* Small screens */
  @media(max-width:900px){.grid{grid-template-columns:1fr}#map{height:300px}}
</style>
</head>
<body>
<header>
  <h1>Emisyon Simülatörü — Trafiğe Uygunluk (demo)</h1>
  <nav>
    <button id="nav-home" class="active">Anasayfa</button>
    <button id="nav-register">Cihaz Kayıt</button>
    <button id="nav-vehicle">Araçlarım</button>
    <button id="nav-rules">Kurallar & Öneriler</button>
    <button id="nav-admin">Ulusal Görünüm</button>
    <button id="nav-global">Global Emisyon Haritası</button>
  </nav>
</header>
<main>
  <!-- SPA bölümleri -->
  <section id="page-home">
    <div class="grid">
      <div class="card">
        <div id="controls">
          <div style="position:relative;flex:1">
            <input id="addressInput" placeholder="Şehir, sokak, okul veya adres girin" autocomplete="off" />
            <div id="resultList"></div>
          </div>
          <button id="locateBtn" class="btn">📍 Konumumu Bul</button>
        </div>
        <div style="margin-top:10px">
          <h3 id="locationLabel">Konum: —</h3>
          <div class="aqi-bar"><div id="aqiBar" class="aqi-fill">—</div></div>
          <p id="aqiText">AQI: —</p>
          <p id="dominantPollutant">Baskın Kirletici: —</p>
          <h4>Kirleticiler:</h4>
          <ul id="pollutants"></ul>
          <p id="warningMsg" style="color:#b22222;font-weight:bold"></p>
          <p id="maskMsg" style="color:#0000aa;font-weight:bold"></p>
          <p id="healthWarning" style="color:#8B0000;font-weight:bold"></p>
        </div>
      </div>
      <aside class="card">
        <h3>Hızlı Araç Emisyon Simülatörü</h3>
        <p class="muted">Bu demo sistemde kullanıcılar aracı ve cihaza ait bir kayıt oluşturur. Sistem kısa aralıklarla (simülasyon) emisyon okuması gönderir ve "Trafiğe Uygun" kararını verir.</p>
        <hr />
        <label>Plaka (ör: 34ABC34)</label>
        <input id="plateInput" placeholder="Plaka girin" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc" />
        <label>Cihaz ID (ör: DEV-0001)</label>
        <input id="deviceInput" placeholder="Cihaz ID girin" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc" />
        <label>Model (isteğe bağlı)</label>
        <input id="modelInput" placeholder="Araç modeli" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc" />
        <button id="registerVehicleBtn" class="btn" style="width:100%;margin-top:6px">Araç & Cihaz Kaydet</button>
        <hr />
        <h4>Son Okuma</h4>
        <div id="lastRead" class="muted">Henüz kayıtlı okuma yok.</div>
        <hr />
        <h4>Uygulama Davranışı</h4>
        <p class="muted">Sistem, cihaz verisini simüle eder. Emisyon eşiklerine göre "Trafiğe Uygun / Uygun Değil" etiketi verir. Ayrıca öneriler gösterir.</p>
      </aside>
    </div>
  </section>

  <section id="page-register" style="display:none">
    <div class="card">
      <h2>Cihaz Kayıt</h2>
      <p class="muted">Gerçekte buradan cihaz seri numarası ve araç bilgisi toplanır. Demo: localStorage kullanılır.</p>
      <label>Plaka</label>
      <input id="reg_plate" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc" />
      <label>Cihaz ID</label>
      <input id="reg_device" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc" />
      <label>Yer (şehir)</label>
      <input id="reg_city" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc" />
      <button id="regBtn" class="btn">Kayıt Oluştur</button>
      <hr />
      <h3>Kayıtlı Cihazlar</h3>
      <div id="registeredList"></div>
    </div>
  </section>

  <section id="page-vehicle" style="display:none">
    <div class="card">
      <h2>Araçlarım</h2>
      <p class="muted">Kayıtlı araçlar ve en son emisyon durumları.</p>
      <div id="myVehicles"></div>
    </div>
  </section>

  <section id="page-rules" style="display:none">
    <div class="card">
      <h2>Kurallar & Ne Yapmalı?</h2>
      <ul>
        <li>PM2.5 &gt; 150 ise <strong>trafikten men</strong> önerilir.</li>
        <li>PM2.5 100-150 arası ise <em>kısıtlı</em> (ör: belirli saatler dışında çıkışa izin verilmeyebilir).</li>
        <li>PM2.5 &lt;= 100 ise normal trafik izni verilir.</li>
      </ul>
      <h3>Öneriler</h3>
      <ol>
        <li>Filtre ve katalizör kontrolü.</li>
        <li>Rutin bakım ve yağ değişimi.</li>
        <li>Gereksiz rölantiyi azalt.</li>
      </ol>
    </div>
  </section>

  <section id="page-admin" style="display:none">
    <div class="card">
      <h2>Ulusal Görünüm (Simüle)</h2>
      <p class="muted">İllere göre rastgele simüle edilmiş cihaz verileri. Gerçekte merkezi bir API ile gelir.</p>
      <div id="nationalMap" style="height:480px;border-radius:8px"></div>
      <div style="margin-top:8px" id="nationalSummary"></div>
    </div>
  </section>

  <section id="page-global" style="display:none">
    <div class="card">
      <h2>Global Emisyon Haritası (Simüle)</h2>
      <p class="muted">Dünya genelinde örnek/simüle emisyon değerleri gösterilir. Bu, ana sayfadaki canlı WAQI haritasının ayrı bir global görünümü olarak yer alır.</p>
      <div id="globalMap" style="height:480px;border-radius:8px"></div>
      <div style="margin-top:8px" id="globalSummary"></div>
    </div>
  </section>

</main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const WAQI_TOKEN="9263e25a74b0d93c30387fa753ec876f19869d38";
const NOMINATIM_BASE="https://nominatim.openstreetmap.org";

// SPA navigation
const pages={home:document.getElementById('page-home'),register:document.getElementById('page-register'),vehicle:document.getElementById('page-vehicle'),rules:document.getElementById('page-rules'),admin:document.getElementById('page-admin'),global:document.getElementById('page-global')};
function show(page){Object.values(pages).forEach(p=>p.style.display='none');pages[page].style.display='block';document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));document.getElementById('nav-'+page).classList.add('active');
  // harita boyutlarını düzelt
  setTimeout(()=>{
    if(window.nationalMap) window.nationalMap.invalidateSize();
    if(window.globalMap) window.globalMap.invalidateSize();
  },250);
}
document.getElementById('nav-home').addEventListener('click',()=>show('home'));
document.getElementById('nav-register').addEventListener('click',()=>show('register'));
document.getElementById('nav-vehicle').addEventListener('click',()=>show('vehicle'));
document.getElementById('nav-rules').addEventListener('click',()=>show('rules'));
document.getElementById('nav-admin').addEventListener('click',()=>show('admin'));
document.getElementById('nav-global').addEventListener('click',()=>show('global'));

// --- Helpers ---
async function nominatimSearch(q){const res=await fetch(`${NOMINATIM_BASE}/search?format=json&addressdetails=1&limit=10&q=${encodeURIComponent(q)}`,{headers:{'Accept-Language':'tr'}});return res.json();}
async function nominatimReverse(lat,lon){const res=await fetch(`${NOMINATIM_BASE}/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`,{headers:{'Accept-Language':'tr'}});return res.json();}

// --- Global map (taşındı) ---
let globalMap; let globalMarker=null;
function setupGlobalMap(){globalMap=L.map('globalMap').setView([20,0],2);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(globalMap);
  globalMap.on('click', async function(e){const lat=e.latlng.lat, lon=e.latlng.lng;try{const rev=await nominatimReverse(lat,lon);const label=rev && rev.display_name?rev.display_name:`Konum (${lat.toFixed(3)}, ${lon.toFixed(3)})`;setGlobalMarker(lat,lon);fetchAQIForGlobal(lat,lon,label);}catch(e){setGlobalMarker(lat,lon);fetchAQIForGlobal(lat,lon,`Konum (${lat.toFixed(3)}, ${lon.toFixed(3)})`);} });
}
function setGlobalMarker(lat,lon){if(globalMarker) globalMarker.setLatLng([lat,lon]); else globalMarker=L.marker([lat,lon]).addTo(globalMap);globalMap.setView([lat,lon],6);} 
async function fetchAQIForGlobal(lat,lon,label){try{const res=await fetch(`https://api.waqi.info/feed/geo:${lat};${lon}/?token=${WAQI_TOKEN}`);const resp=await res.json();if(resp.status==='ok') updateAQIUI(resp.data,label); else updateAQIUI(null,label);}catch(err){console.error(err);updateAQIUI(null,label);} }

// UI elements (home uses only AQI UI, global map handles clicks)
const addressInput=document.getElementById('addressInput');
const resultList=document.getElementById('resultList');
const locateBtn=document.getElementById('locateBtn');
const aqiBar=document.getElementById('aqiBar');
const aqiText=document.getElementById('aqiText');
const dominantPollutant=document.getElementById('dominantPollutant');
const pollutantsEl=document.getElementById('pollutants');
const warningMsg=document.getElementById('warningMsg');
const maskMsg=document.getElementById('maskMsg');
const healthWarningEl=document.getElementById('healthWarning');

function debounce(fn,wait){let t;return function(...args){clearTimeout(t);t=setTimeout(()=>fn.apply(this,args),wait);};}

addressInput.addEventListener('input',debounce(async function(){const q=addressInput.value;if(!q){resultList.style.display='none';return;}const res=await nominatimSearch(q);renderResults(res);},250));

function renderResults(items){resultList.innerHTML='';if(!items||items.length===0){resultList.style.display='none';return;}items.forEach(item=>{const div=document.createElement('div');div.className='resultItem';div.innerHTML=`<strong>${item.display_name}</strong>`;div.addEventListener('click',()=>{selectResult(item)});resultList.appendChild(div);});resultList.style.display='block';}
async function selectResult(item){resultList.style.display='none';addressInput.value=item.display_name;const lat=parseFloat(item.lat),lon=parseFloat(item.lon);setGlobalMarker(lat,lon);fetchAQIForGlobal(lat,lon,item.display_name);}

locateBtn.addEventListener('click',()=>{if(navigator.geolocation){navigator.geolocation.getCurrentPosition(async pos=>{const lat=pos.coords.latitude,lon=pos.coords.longitude;const rev=await nominatimReverse(lat,lon);const label=rev && rev.display_name?rev.display_name:`Konum (${lat.toFixed(3)}, ${lon.toFixed(3)})`;setGlobalMarker(lat,lon);fetchAQIForGlobal(lat,lon,label);},err=>alert('Konuma erişilemiyor.'))}else alert('Geolocation desteklenmiyor.');});

function updateAQIUI(data,label){document.getElementById('locationLabel').textContent='Konum: '+(label||'—');const aqi=data&&data.aqi?data.aqi:null;aqiText.textContent='AQI: '+(aqi!==null?aqi:'—');dominantPollutant.textContent='Baskın Kirletici: '+((data&&data.dominentpol)?data.dominentpol.toUpperCase():'—');let color='green';if(aqi===null) color='#999';else if(aqi<=50) color='green';else if(aqi<=100) color='yellow';else if(aqi<=150) color='orange';else if(aqi<=200) color='red';else if(aqi<=300) color='purple';else color='maroon';aqiBar.style.background=color;aqiBar.style.width=(aqi===null?0:Math.min(aqi,500)/500*100)+'%';aqiBar.textContent=(aqi===null?'—':aqi);pollutantsEl.innerHTML='';const keys=["co","h","no2","o3","p","pm10","pm25","so2","t","w"];if(data&&data.iaqi){keys.forEach(k=>{if(data.iaqi[k]){const li=document.createElement('li');li.textContent=`${k.toUpperCase()}: ${data.iaqi[k].v}`;pollutantsEl.appendChild(li);}})}
}

// --- Basit kayıt / cihaz simülasyonu ---
function loadRegistry(){try{return JSON.parse(localStorage.getItem('emission_registry')||'[]')}catch(e){return []}}
function saveRegistry(reg){localStorage.setItem('emission_registry',JSON.stringify(reg));}

function renderRegistered(){const list=document.getElementById('registeredList');const reg=loadRegistry();if(!list) return; if(reg.length===0){list.innerHTML='<div class="muted">Kayıtlı cihaz yok.</div>';return;}list.innerHTML='';reg.forEach(r=>{const div=document.createElement('div');div.style.padding='8px';div.style.borderBottom='1px solid #eee';div.innerHTML=`<strong>${r.plate}</strong> — ${r.device} <div class="muted">${r.city||''}</div>`;list.appendChild(div);});}

// register form
document.getElementById('regBtn').addEventListener('click',()=>{const plate=document.getElementById('reg_plate').value.trim();const device=document.getElementById('reg_device').value.trim();const city=document.getElementById('reg_city').value.trim();if(!plate||!device){alert('Plaka ve cihaz ID gerekli');return;}const reg=loadRegistry();const newRec={plate,device,city,created:Date.now(),lastRead:null};reg.push(newRec);saveRegistry(reg);renderRegistered();document.getElementById('reg_plate').value='';document.getElementById('reg_device').value='';document.getElementById('reg_city').value='';alert('Kayıt oluşturuldu (demo).');
  // kayıt sonrası yavaş yavaş ilk okumaları üret
  const idx=reg.length-1;gradualChange(idx,{start:30,target:Math.round(Math.random()*140+10),steps:6,interval:2500});
});

// hızlı kayıt butonu (aside)
document.getElementById('registerVehicleBtn').addEventListener('click',()=>{const plate=document.getElementById('plateInput').value.trim();const device=document.getElementById('deviceInput').value.trim();const model=document.getElementById('modelInput').value.trim();if(!plate||!device){alert('Plaka ve cihaz girin');return;}const reg=loadRegistry();reg.push({plate,device,model,created:Date.now(),lastRead:null});saveRegistry(reg);document.getElementById('lastRead').textContent='Kayıt oluşturuldu: '+plate;document.getElementById('plateInput').value='';document.getElementById('deviceInput').value='';document.getElementById('modelInput').value='';renderRegistered();renderMyVehicles();
  // hızlı kayıtta da kademeli okuma başlat
  const idx=loadRegistry().length-1;gradualChange(idx,{start:20,target:Math.round(Math.random()*140+10),steps:6,interval:2500});
});

// Araçlarım sayfası
function renderMyVehicles(){const cont=document.getElementById('myVehicles');const reg=loadRegistry();if(!cont) return; if(reg.length===0){cont.innerHTML='<div class="muted">Kayıtlı araç yok.</div>';return;}cont.innerHTML='';reg.forEach((r,idx)=>{const box=document.createElement('div');box.style.border='1px solid #eee';box.style.padding='8px';box.style.borderRadius='6px';box.style.marginBottom='8px';const last=r.lastRead?`<div>Son PM2.5: <strong>${r.lastRead.pm25}</strong> — Durum: <strong>${r.lastRead.status}</strong></div>`:'<div class="muted">Henüz okuma yok.</div>';box.innerHTML=`<strong>${r.plate}</strong> — ${r.device}<div class="muted">${r.model||''} ${r.city?'- '+r.city:''}</div>${last}<div style="margin-top:8px"><button class="btn" data-idx="${idx}" onclick="forceRead(this)">Manuel Okuma Al</button> <button class="btn" data-idx="${idx}" onclick="simulateTrip(this)">Simüle Seyahat</button></div>`;cont.appendChild(box);});}

window.forceRead = function(btn){const idx=parseInt(btn.dataset.idx);simulateDeviceRead(idx);}
window.simulateTrip = function(btn){const idx=parseInt(btn.dataset.idx);const reg=loadRegistry();if(!reg[idx])return; // simule seyahat: kademeli artış (yavaşça yükselir)
  gradualChange(idx,{start: reg[idx].lastRead?reg[idx].lastRead.pm25:30, target: Math.min(400, Math.round((reg[idx].lastRead?reg[idx].lastRead.pm25:30) * (1.6 + Math.random()*0.6))), steps:8, interval:3000});}

// cihaz okuması simülasyonu (anlık)
function simulateDeviceRead(index, opts={}){const reg=loadRegistry();if(!reg[index]) return;const basePM25 = Math.round( Math.random()*180 );const pm25 = Math.max(0, Math.round(basePM25 * (opts.multiply||1) ));const pm10 = Math.round(pm25 * (0.6 + Math.random()*0.8));const co = (Math.random()*6).toFixed(2);const status = decideStatus(pm25);const read = {ts:Date.now(),pm25,pm10,co,status};reg[index].lastRead=read;saveRegistry(reg);renderMyVehicles();document.getElementById('lastRead').innerHTML=`${reg[index].plate} — PM2.5: ${pm25} — ${status}`;}

function decideStatus(pm25){if(pm25>150) return 'TRAFİĞE UYGUN DEĞİL';if(pm25>100) return 'SINIRLI (KISITLI SAAT)';return 'TRAFİĞE UYGUN';}

// kademeli/ yavaş değişim fonksiyonu
function gradualChange(index, opts={start:20,target:80,steps:6,interval:3000}){const reg=loadRegistry();if(!reg[index]) return;let step=0;const start=opts.start;const target=opts.target;const steps=opts.steps||6;const interval=opts.interval||3000;const delta = (target - start)/steps;const iv=setInterval(()=>{step++;const currentVal = Math.round(start + delta*step + (Math.random()*5-2));const pm25 = Math.max(0, currentVal);const pm10 = Math.round(pm25 * (0.6 + Math.random()*0.8));const co = (Math.random()*6).toFixed(2);const status = decideStatus(pm25);const read = {ts:Date.now(),pm25,pm10,co,status};const registry=loadRegistry();if(!registry[index]){clearInterval(iv);return;}registry[index].lastRead=read;saveRegistry(registry);renderMyVehicles();document.getElementById('lastRead').innerHTML=`${registry[index].plate} — PM2.5: ${pm25} — ${status}`;if(step>=steps) clearInterval(iv);},interval);}

// periyodik simülasyon: kayıtlı her cihaza rastgele okuma gönder
function startBackgroundSimulation(){// demo: her 20s de bir tüm kayıtları güncelle
  setInterval(()=>{
    const reg=loadRegistry();if(!reg.length) return;for(let i=0;i<reg.length;i++){ // biraz rastgelelik
      if(Math.random()<0.5) simulateDeviceRead(i);
    }
    renderMyVehicles();
  },20000);
}

// --- Ulusal görünüm (simüle) ---
const provinces=[
  {name:'İstanbul',lat:41.01,lon:28.97},
  {name:'Ankara',lat:39.92,lon:32.86},
  {name:'İzmir',lat:38.42,lon:27.14},
  {name:'Bursa',lat:40.19,lon:29.06},
  {name:'Antalya',lat:36.88,lon:30.70},
  {name:'Adana',lat:36.99,lon:35.32},
  {name:'Samsun',lat:41.28,lon:36.33}
];
function setupNationalMap(){window.nationalMap=L.map('nationalMap').setView([39.0,35.0],5);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(window.nationalMap);provinces.forEach(p=>{const fakePM25=Math.round( Math.random()*240 );const color=getColorForPM25(fakePM25);const marker=L.circleMarker([p.lat,p.lon],{radius:12,color:color,fillColor:color,fillOpacity:0.7}).addTo(window.nationalMap);marker.bindPopup(`<strong>${p.name}</strong><br>PM2.5 (simüle): ${fakePM25}`);});document.getElementById('nationalSummary').innerHTML=`<div class="muted">Toplam iller: ${provinces.length}. Bu gösterim tamamen simüle amaçlı.</div>`;}
function getColorForPM25(v){if(v<=50) return 'green'; if(v<=100) return 'yellow'; if(v<=150) return 'orange'; if(v<=200) return 'red'; if(v<=300) return 'purple'; return 'maroon';}

// küçük inits
renderRegistered();renderMyVehicles();startBackgroundSimulation();setupNationalMap();setupGlobalMap();

// global summary (örnek)
function populateGlobalSummary(){const countries=['Türkiye','Almanya','Hindistan','Çin','Brezilya','ABD','Rusya'];let html='<div class="muted">Örnek ülke verileri (simüle):</div><ul>';countries.forEach(c=>{html+=`<li>${c}: PM2.5 ~ ${Math.round(Math.random()*200)}</li>`});html+='</ul>';document.getElementById('globalSummary').innerHTML=html;}
populateGlobalSummary();

// sayfa değişimlerinde map resize
window.addEventListener('resize',()=>{setTimeout(()=>{if(window.nationalMap) window.nationalMap.invalidateSize(); if(window.globalMap) window.globalMap.invalidateSize();},200)});

// butonlar harici
function simulateAllReadsNow(){const reg=loadRegistry();for(let i=0;i<reg.length;i++){simulateDeviceRead(i);}renderMyVehicles();}
window.simulateAllReadsNow=simulateAllReadsNow;

</script>
</body>
</html>
